<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitTrack AI | Nutrition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Added for barcode scanning -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        :root {
            --background: #000000;
            --primary-text: #eaeaea;
            --secondary-text: #888888;
            --card-bg: #111111;
            --input-bg: #191919;
            --border-color: #222222;
            --accent: #FFFFFF;
            --accent-hover: #DDDDDD;
            --danger: #E53E3E;
            --edit: #3b82f6;
            --nav-footer-height: 64px; /* Set height of the new fixed footer nav */
        }

        html, body {
            overscroll-behavior-y: contain;
            /* Ensure content has room above the fixed footer */
            padding-bottom: var(--nav-footer-height); 
        }

        body {
            background-color: var(--background);
            color: var(--primary-text);
            font-family: 'Manrope', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .nav-link {
            /* Styles for the footer navigation links */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
            height: 100%;
            transition: color 0.3s ease;
            color: var(--secondary-text);
            font-size: 0.75rem;
            text-decoration: none;
            padding-top: 4px;
        }

        .nav-link:hover {
            color: var(--primary-text);
        }

        .nav-link.active {
            color: var(--primary-text);
        }

        .nav-link.active .nav-icon {
            color: var(--primary-text);
        }

        .nav-icon {
            margin-bottom: 2px;
            width: 24px;
            height: 24px;
        }
        
        #mobile-footer-nav {
            background-color: var(--card-bg); /* Ensure it is fully opaque */
        }

        .content-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1.5rem;
        }

        .form-input {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            color: var(--primary-text);
            padding: 0.75rem 1rem;
            width: 100%;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
        }

        .form-label {
            color: var(--secondary-text);
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .btn {
            border-radius: 0.5rem;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            transition: all 0.2s ease-in-out;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transform: translateY(0);
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: translateY(0);
        }

        .btn-primary {
            background-color: var(--accent);
            color: var(--background);
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--accent-hover);
        }
        
        .btn-secondary {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--primary-text);
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: var(--border-color);
            border-color: var(--accent);
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: var(--primary-text);
        }
        
        .btn-danger:hover:not(:disabled) {
             background-color: #C53030;
        }

        .modal-backdrop {
            display: none;
            position: fixed;
            z-index: 50;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        .modal-content {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 550px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .loader {
            border: 2px solid #333;
            border-top: 2px solid var(--accent);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: var(--input-bg); border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #666; }
        
        .recipe-ingredients-details { display: none; }

        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }

        /* Prevents number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
          -moz-appearance: textfield;
        }

        /* Swipe gesture styles from workouts.html */
        .swipe-item {
            position: relative;
            overflow: hidden;
            user-select: none;
        }
        .swipe-actions {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            align-items: center;
        }
        .swipe-action-container {
            position: absolute;
            top: 0; bottom: 0;
            width: 100%;
            display: flex;
            align-items: center;
            opacity: 0; /* Hidden by default */
            transition: opacity 0.3s ease;
        }
        .swipe-action-container.left { /* Delete */
            justify-content: flex-start;
            background: linear-gradient(to right, hsl(0, 72%, 51%), hsl(0, 82%, 61%));
        }
        .swipe-action-container.right { /* Edit */
            justify-content: flex-end;
            background: linear-gradient(to left, hsl(217, 91%, 60%), hsl(217, 81%, 70%));
        }
        .swipe-actions .action {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            padding: 0 1.5rem;
        }
        .swipe-content {
            position: relative;
            background-color: var(--card-bg);
            touch-action: pan-y; /* Allow vertical scroll while capturing horizontal */
            cursor: pointer;
        }
        .swipe-content.swiping {
            transition: none; /* No transition while actively dragging */
        }
        .swipe-content.returning {
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto max-w-7xl px-4 py-8">

        <!-- Header -->
        <header class="flex items-center justify-between mb-8 pb-4 border-b border-gray-900">
            <a href="index.html" class="flex items-center gap-3">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m6 2 4 4"/><path d="m3 10.5 4.5-4.5"/><path d="m13.5 21 4.5-4.5"/></svg>
                <h1 class="text-2xl font-bold">FitTrack AI</h1>
            </a>
        </header>

        <!-- Main Content -->
        <main class="grid grid-cols-1 gap-8">
                <!-- Left Column -->
                <div class="space-y-8">
                    <div class="content-card">
                        <h3 class="text-2xl font-bold mb-6">Log Your Meal</h3>
                        <form id="log-meal-form" class="space-y-4">
                            <div>
                                <label for="food-name-input" class="form-label">Food Name *</label>
                                <input type="text" id="food-name-input" list="favorite-foods-datalist" placeholder="e.g., Chicken Breast" class="form-input mt-1">
                                <datalist id="favorite-foods-datalist"></datalist>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="food-servings-input" class="form-label">Servings *</label>
                                    <input type="number" id="food-servings-input" placeholder="1" value="1" min="0" step="0.1" class="form-input mt-1">
                                </div>
                                <div>
                                    <label for="food-brand-input" class="form-label">Brand (Optional)</label>
                                    <input type="text" id="food-brand-input" placeholder="e.g., Tesco" class="form-input mt-1">
                                </div>
                            </div>

                            <details class="pt-2">
                                <summary class="cursor-pointer text-sm text-gray-400 hover:text-white flex items-center justify-between">
                                    <span>Enter Macros for 1 Serving</span>
                                    <i data-lucide="chevron-down" class="w-4 h-4"></i>
                                </summary>
                                <div class="space-y-3 pt-4 mt-4 border-t border-gray-800">
                                    <div class="grid grid-cols-4 gap-2">
                                        <div>
                                            <label for="food-grams-input" class="form-label text-xs">Grams</label>
                                            <input type="number" id="food-grams-input" placeholder="g" min="0" class="form-input mt-1 !py-1.5 text-sm">
                                        </div>
                                        <div>
                                            <label class="form-label text-xs">Calories</label>
                                            <input type="number" step="0.01" id="food-calories-input" min="0" placeholder="kcal" class="form-input mt-1 !py-1.5 text-sm macro-input">
                                        </div>
                                        <div>
                                            <label class="form-label text-xs">Protein</label>
                                            <input type="number" step="0.01" id="food-protein-input" min="0" placeholder="g" class="form-input mt-1 !py-1.5 text-sm macro-input">
                                        </div>
                                        <div>
                                            <label class="form-label text-xs">Fat</label>
                                            <input type="number" step="0.01" id="food-fat-input" min="0" placeholder="g" class="form-input mt-1 !py-1.5 text-sm macro-input">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-4 gap-2">
                                        <div>
                                            <label class="form-label text-xs">Carbs</label>
                                            <input type="number" step="0.01" id="food-carbs-input" min="0" placeholder="g" class="form-input mt-1 !py-1.5 text-sm macro-input">
                                        </div>
                                        <div>
                                            <label class="form-label text-xs">Sugar</label>
                                            <input type="number" step="0.01" id="food-sugar-input" min="0" placeholder="g" class="form-input mt-1 !py-1.5 text-sm macro-input">
                                        </div>
                                        <div>
                                            <label class="form-label text-xs">Potassium</label>
                                            <input type="number" step="0.01" id="food-potassium-input" min="0" placeholder="mg" class="form-input mt-1 !py-1.5 text-sm macro-input">
                                        </div>
                                        <div>
                                            <label class="form-label text-xs">Sodium</label>
                                            <input type="number" step="0.01" id="food-sodium-input" min="0" placeholder="mg" class="form-input mt-1 !py-1.5 text-sm macro-input">
                                        </div>
                                    </div>
                                </div>
                            </details>
                            
                            <div class="flex gap-4 pt-6">
                                <button id="scan-barcode-btn" type="button" class="btn btn-secondary !p-3" title="Scan Barcode"><i data-lucide="barcode"></i></button>
                                <button id="create-recipe-btn" type="button" class="btn btn-secondary !p-3" title="Create Recipe"><i data-lucide="notebook-tabs"></i></button>
                                <button id="add-food-btn" type="button" class="btn btn-primary w-full">
                                    <i data-lucide="sparkles" class="w-4 h-4"></i>
                                    <span class="btn-text">Add Food</span>
                                    <div class="loader hidden"></div>
                                </button>
                                <button id="add-water-btn" type="button" class="btn btn-secondary !p-3" title="Log Water"><i data-lucide="glass-water"></i></button>
                                <button id="scan-food-btn" type="button" class="btn btn-secondary !p-3" title="Scan Food with AI Camera"><i data-lucide="camera"></i></button>
                            </div>
                            <div id="add-food-error" class="text-red-400 text-sm mt-2 h-4"></div>
                        </form>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="space-y-8">
                    <div id="daily-summary-card" class="content-card">
                         <!-- Date Navigation -->
                         <div class="text-center mb-4">
                            <h3 class="text-xl font-bold">
                                <span id="day-view-title-span" class="block text-2xl font-semibold">Today</span>
                                <span id="day-view-date-span" class="text-base text-secondary-text"></span>
                            </h3>
                        </div>
                        
                        <h3 class="text-2xl font-bold mb-4 border-t border-border-color pt-4">Daily Summary</h3>
                        <div class="flex items-center gap-6">
                            <div class="w-24 h-24 flex-shrink-0">
                                <canvas id="macro-chart"></canvas>
                            </div>
                            <div class="w-full grid grid-cols-2 gap-x-6 gap-y-2 text-sm">
                                <div class="flex justify-between items-baseline"><span class="text-gray-400">Calories:</span> <span class="font-semibold"><span id="current-calories">0</span> / <span id="goal-calories">2000</span></span></div>
                                <div class="flex justify-between items-baseline"><span class="text-gray-400">Protein:</span> <span class="font-semibold"><span id="current-protein">0</span> / <span id="goal-protein">150</span> g</span></div>
                                <div class="flex justify-between items-baseline"><span class="text-gray-400">Carbs:</span> <span class="font-semibold"><span id="current-carbs">0</span> / <span id="goal-carbs">225</span> g</span></div>
                                <div class="flex justify-between items-baseline"><span class="text-gray-400">Fat:</span> <span class="font-semibold"><span id="current-fat">0</span> / <span id="goal-fat">60</span> g</span></div>
                                <div class="flex justify-between items-baseline"><span class="text-gray-400">Sugar:</span> <span class="font-semibold"><span id="current-sugar">0</span> / <span id="goal-sugar">50</span> g</span></div>
                                <div class="flex justify-between items-baseline"><span class="text-gray-400">Sodium:</span> <span class="font-semibold"><span id="current-sodium">0</span> / <span id="goal-sodium">2300</span> mg</span></div>
                                <div class="flex justify-between items-baseline"><span class="text-gray-400">Potassium:</span> <span class="font-semibold"><span id="current-potassium">0</span> / <span id="goal-potassium">3500</span> mg</span></div>
                                <div class="flex justify-between items-baseline"><span class="text-gray-400">Water:</span> <span class="font-semibold"><span id="current-water">0</span> / <span id="goal-water">2500</span> ml</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Daily Log Content & AI Report Output -->
                    <div class="content-card">
                        <h3 class="text-2xl font-bold mb-4">Food Log</h3>
                        <div id="daily-log-content" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar pr-2"><p class="text-gray-500">No food logged yet.</p></div>
                         <button id="ai-daily-report-btn" class="btn btn-primary w-full mt-6">
                            <i data-lucide="clipboard-list" class="w-4 h-4"></i>
                            <span class="btn-text">Get Daily Log AI Report</span>
                            <div class="loader hidden"></div>
                        </button>
                    </div>

                    <div class="content-card">
                        <h3 class="text-2xl font-bold mb-4">Favorites & Recipes</h3>
                        <div id="saved-items-list" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar pr-2"></div>
                    </div>
                </div>

                <!-- AI Sections moved to the bottom -->
                <div class="content-card col-span-1">
                    <h3 class="text-2xl font-bold mb-4">AI Coach</h3>
                     <div class="grid grid-cols-1 gap-8">
                         <div>
                            <h4 class="font-semibold text-lg mb-2">Meal Suggester</h4>
                            <p class="text-gray-400 mb-4 text-sm">Enter ingredients you have, and the AI will suggest a quick, healthy meal.</p>
                             <div>
                                <label for="ai-ingredients" class="form-label">Your Ingredients</label>
                                <textarea id="ai-ingredients" rows="3" class="form-input mt-1" placeholder="e.g., chicken breast, rice, broccoli, olive oil"></textarea>
                            </div>
                            <button id="ai-suggestion-btn" class="btn btn-secondary w-full mt-4">
                                <span class="btn-text">Generate Ideas</span>
                                <div class="loader hidden"></div>
                            </button>
                            <div id="ai-suggestions-output" class="mt-4 space-y-3"></div>
                         </div>
                         <div>
                            <h4 class="font-semibold text-lg mb-2">Nutritionist Chat</h4>
                            <p class="text-gray-400 mb-4 text-sm">Ask for specific advice about your diet, or have a general chat about nutrition.</p>
                            <div class="bg-black/30 p-4 rounded-lg text-center">
                                <i data-lucide="message-circle" class="w-12 h-12 text-blue-400 mx-auto mb-4"></i>
                                <button id="open-nutritionist-chat-btn" class="btn btn-primary w-full">Chat with AI Nutritionist</button>
                            </div>
                         </div>
                     </div>
                </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="food-scanner-modal" class="modal-backdrop" style="z-index: 60;">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Scan Food with AI</h2>
                <button id="close-food-scanner-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            <div class="space-y-4">
                <div id="food-scanner-initial-options" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <label for="upload-photo-input" class="btn btn-secondary cursor-pointer"><i data-lucide="upload"></i>Upload Photo(s)</label>
                    <input type="file" id="upload-photo-input" class="hidden" accept="image/*" multiple>
                    <button id="start-food-camera-btn" class="btn btn-secondary"><i data-lucide="camera"></i>Start Live Camera</button>
                </div>
                <div id="live-camera-container" class="hidden space-y-2">
                    <video id="food-camera-video" class="w-full rounded-lg border border-border-color" autoplay playsinline></video>
                    <canvas id="food-camera-canvas" class="hidden"></canvas> <!-- For capturing frames -->
                    <button id="capture-food-photo-btn" class="btn btn-primary w-full">Capture Photo</button>
                    <button id="stop-food-camera-btn" class="btn btn-danger w-full">Close Camera</button>
                </div>
                <div id="scanner-results-container" class="mt-4 space-y-3 max-h-60 overflow-y-auto custom-scrollbar"></div>
                <p id="food-scanner-status" class="text-center text-sm text-gray-400 mt-2 h-5"></p>
            </div>
        </div>
    </div>
    <div id="barcode-scanner-modal" class="modal-backdrop" style="z-index: 60;"><div class="modal-content"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Scan Barcode</h2><button id="close-barcode-scanner-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div><div class="space-y-4"><div id="barcode-reader" class="w-full aspect-square bg-black rounded-lg border border-border-color hidden"></div><div id="barcode-initial-options" class="flex flex-col gap-4"><button id="start-camera-scan-btn" class="btn btn-primary w-full"><i data-lucide="camera"></i>Start Live Scan</button><label for="barcode-upload-input" class="btn btn-secondary cursor-pointer w-full"><i data-lucide="upload"></i>Upload Barcode Image(s)</label><input type="file" id="barcode-upload-input" class="hidden" accept="image/*" multiple></div><p id="barcode-scanner-status" class="text-center text-sm text-secondary-text h-5"></p><div id="barcode-results" class="mt-4 p-4 bg-black/30 rounded-lg min-h-[100px] space-y-2 max-h-60 overflow-y-auto custom-scrollbar"></div></div></div></div>
    <div id="confirm-modal" class="modal-backdrop"><div class="modal-content"><h2 id="confirm-modal-title" class="text-xl font-bold mb-4">Are you sure?</h2><p id="confirm-modal-text" class="text-gray-300 mb-6">This action cannot be undone.</p><div class="flex justify-end gap-4"><button id="confirm-modal-cancel-btn" class="btn btn-secondary">Cancel</button><button id="confirm-modal-confirm-btn" class="btn btn-danger">Confirm</button></div></div></div>
    <div id="alert-modal" class="modal-backdrop"><div class="modal-content"><h2 id="alert-modal-title" class="text-xl font-bold mb-4">Alert</h2><p id="alert-modal-text" class="text-gray-300 mb-6"></p><div class="flex justify-end"><button id="alert-modal-ok-btn" class="btn btn-primary">OK</button></div></div></div>
    <div id="ai-report-modal" class="modal-backdrop"><div class="modal-content"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold flex items-center gap-2"><i data-lucide="sparkles" class="w-5 h-5 text-yellow-400"></i>AI Nutrition Report</h2><button id="close-ai-report-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div><p id="ai-report-modal-text" class="text-gray-300 mb-6"></p><div class="flex justify-end"><button id="ai-report-modal-ok-btn" class="btn btn-primary">OK</button></div></div></div>
    <div id="compound-food-modal" class="modal-backdrop"><div class="modal-content !max-w-3xl"><div class="flex justify-between items-center mb-6"><h2 id="compound-food-modal-title" class="text-2xl font-bold">Create a Recipe</h2><button id="close-compound-food-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div><form id="compound-food-form" class="space-y-6"><div><label for="recipe-name-input" class="form-label">Recipe Name</label><input type="text" id="recipe-name-input" class="form-input mt-1" required placeholder="e.g., Turkey Sandwich"></div><div class="border-t border-b border-gray-800 py-4"><h3 class="text-lg font-semibold mb-3">Ingredients</h3><div id="ingredient-list-container" class="space-y-4 max-h-60 overflow-y-auto custom-scrollbar pr-2"></div><button type="button" id="add-ingredient-btn" class="btn btn-secondary w-full mt-4"><i data-lucide="plus"></i>Add Ingredient</button></div><div><h3 class="text-lg font-semibold mb-3">Total Macros</h3><div id="recipe-totals" class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center"><div><p class="text-sm text-gray-400">Calories</p><p id="recipe-total-calories" class="font-bold text-xl">0</p></div><div><p class="text-sm text-gray-400">Protein</p><p class="font-bold text-xl"><span id="recipe-total-protein">0</span>g</p></div><div><p class="text-sm text-gray-400">Carbs</p><p class="font-bold text-xl"><span id="recipe-total-carbs">0</span>g</p></div><div><p class="text-sm text-gray-400">Fat</p><p class="font-bold text-xl"><span id="recipe-total-fat">0</span>g</p></div><div><p class="text-sm text-gray-400">Sugar</p><p class="font-bold text-xl"><span id="recipe-total-sugar">0</span>g</p></div><div><p class="text-sm text-gray-400">Sodium</p><p class="font-bold text-xl"><span id="recipe-total-sodium">0</span>mg</p></div><div><p class="text-sm text-gray-400">Potassium</p><p class="font-bold text-xl"><span id="recipe-total-potassium">0</span>mg</p></div></div><p class="text-center text-sm text-gray-400 mt-2">Total Weight: <span id="recipe-total-grams" class="font-bold">0</span>g</p></div><button type="submit" id="save-recipe-btn" class="btn btn-primary w-full">Save & Log Recipe</button></form></div></div>
    <div id="prompt-modal" class="modal-backdrop"><div class="modal-content"><h2 id="prompt-modal-title" class="text-xl font-bold mb-4">Input Required</h2><p id="prompt-modal-text" class="text-gray-300 mb-4"></p><input type="number" id="prompt-modal-input" min="0" class="form-input mb-6"><div class="flex justify-end gap-4"><button id="prompt-modal-cancel-btn" class="btn btn-secondary">Cancel</button><button id="prompt-modal-ok-btn" class="btn btn-primary">OK</button></div></div></div>
    <div id="edit-favorite-modal" class="modal-backdrop"><div class="modal-content"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Edit Favorite Food</h2><button id="close-edit-favorite-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div><form id="edit-favorite-form" class="space-y-4"><p class="text-sm text-gray-400">All values should be per 100g.</p><div><label for="edit-fav-food-name" class="form-label">Food Name</label><input type="text" id="edit-fav-food-name" class="form-input mt-1" required></div><div class="grid grid-cols-2 gap-4"><div><label for="edit-fav-food-calories" class="form-label">Calories (kcal)</label><input type="number" step="0.01" min="0" id="edit-fav-food-calories" class="form-input mt-1" required></div><div><label for="edit-fav-food-protein" class="form-label">Protein (g)</label><input type="number" step="0.01" min="0" id="edit-fav-food-protein" class="form-input mt-1" required></div></div><div class="grid grid-cols-2 gap-4"><div><label for="edit-fav-food-carbs" class="form-label">Carbs (g)</label><input type="number" step="0.01" min="0" id="edit-fav-food-carbs" class="form-input mt-1" required></div><div><label for="edit-fav-food-fat" class="form-label">Fat (g)</label><input type="number" step="0.01" min="0" id="edit-fav-food-fat" class="form-input mt-1" required></div></div><button type="submit" class="btn btn-primary w-full">Update Favorite</button></form></div></div>
    <!-- AI Nutritionist Chat Modal -->
    <div id="ai-nutritionist-modal" class="modal-backdrop"><div class="modal-content !max-w-2xl flex flex-col"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">AI Nutritionist Chat</h2><button id="close-ai-nutritionist-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div><div id="ai-chat-history" class="flex-grow space-y-4 overflow-y-auto custom-scrollbar pr-2 mb-4 min-h-[300px]"></div><div class="flex gap-2"><input type="text" id="ai-chat-input" class="form-input" placeholder="Ask a nutrition question..."><button id="ai-chat-send-btn" class="btn btn-primary"><i data-lucide="send"></i></button></div></div></div>

    <!-- FIXED MOBILE FOOTER NAV BAR -->
    <nav id="mobile-footer-nav" class="fixed bottom-0 left-0 right-0 h-16 bg-card-bg border-t border-border-color z-50 flex justify-around items-center">
        <a href="index.html" class="nav-link">
            <i data-lucide="home" class="nav-icon"></i>
            <span>Home</span>
        </a>
        <a href="nutrition.html" class="nav-link active">
            <i data-lucide="utensils" class="nav-icon"></i>
            <span>Nutrition</span>
        </a>
        <a href="workouts.html" class="nav-link">
            <i data-lucide="dumbbell" class="nav-icon"></i>
            <span>Workouts</span>
        </a>
        <a href="sleep.html" class="nav-link">
            <i data-lucide="moon" class="nav-icon"></i>
            <span>Sleep</span>
        </a>
        <a href="settings.html" class="nav-link">
            <i data-lucide="settings" class="nav-icon"></i>
            <span>Settings</span>
        </a>
    </nav>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let allDailyLogs = {}; 
            let goals = { calories: 2000, protein: 150, carbs: 225, fat: 60, sugar: 50, sodium: 2300, potassium: 3500, water: 2500 };
            let userProfile = { goal: 'maintain weight', waterServingSize: 250 };
            let favoriteFoods = [];
            let savedRecipes = [];
            let editingFoodLogIndex = null;
            let editingFavoriteFoodName = null;
            let editingRecipeIndex = null;
            let confirmCallback = null;
            let promptCallback = null;
            let scanningIngredientRow = null; 
            let viewDate = new Date();
            viewDate.setHours(0, 0, 0, 0);
            let html5QrCode;
            let foodCameraStream = null;
            let aiBaseMacros = null;
            let chatHistory = [];
            let lastScannedBarcode = { code: null, time: 0 };


            // --- CORE & HELPER FUNCTIONS ---
            function dateToKey(date) { return date.toISOString().split('T')[0]; }
            
            function getDayLog(date) {
                const key = dateToKey(date);
                if (!allDailyLogs[key]) {
                    allDailyLogs[key] = { entries: [], water: 0 };
                }
                return allDailyLogs[key];
            }
            
            function getCurrentDayLogEntries() { return getDayLog(viewDate).entries; }

            function getApiUrl(model, action = 'generateContent') { const apiKey = "AIzaSyDY48xF1byvU05kS9qKvN8iyrIR3hheP8w"; return `https://generativelanguage.googleapis.com/v1beta/models/${model}:${action}?key=${apiKey}`; };
            function showModal(modalElement) { modalElement.style.display = 'flex'; }
            function hideModal(modalElement) { modalElement.style.display = 'none'; }
            function showCustomAlert(title, text) { ui.alertModalTitle.textContent = title; ui.alertModalText.textContent = text; showModal(ui.alertModal); }
            function showConfirmModal(title, text, onConfirm) { ui.confirmModalTitle.textContent = title; ui.confirmModalText.textContent = text; confirmCallback = onConfirm; showModal(ui.confirmModal); }
            function showPromptModal(title, text, defaultValue, onConfirm) { ui.promptModalTitle.textContent = title; ui.promptModalText.textContent = text; ui.promptModalInput.value = defaultValue; promptCallback = onConfirm; showModal(ui.promptModal); ui.promptModalInput.focus(); ui.promptModalInput.select(); }

            function saveData() {
                localStorage.setItem('fitTrackAI_allDailyLogs', JSON.stringify(allDailyLogs));
                localStorage.setItem('fitTrackAI_userProfile', JSON.stringify(userProfile));
                localStorage.setItem('fitTrackAI_favoriteFoods', JSON.stringify(favoriteFoods));
                localStorage.setItem('fitTrackAI_savedRecipes', JSON.stringify(savedRecipes));
                localStorage.setItem('fitTrackAI_goals', JSON.stringify(goals));
                localStorage.setItem('fitTrackAI_chatHistory', JSON.stringify(chatHistory));
            }

            function loadData() {
                let logs = JSON.parse(localStorage.getItem('fitTrackAI_allDailyLogs')) || {};
                // Migration for old data structure
                for(const date in logs) {
                    if(Array.isArray(logs[date])) {
                        logs[date] = {
                            entries: logs[date].filter(item => item.name !== 'Water'), // Remove old water entries
                            water: 0
                        }
                    }
                }
                allDailyLogs = logs;

                chatHistory = JSON.parse(localStorage.getItem('fitTrackAI_chatHistory')) || [];
                userProfile = JSON.parse(localStorage.getItem('fitTrackAI_userProfile')) || { goal: 'maintain weight', waterServingSize: 250 };
                goals = JSON.parse(localStorage.getItem('fitTrackAI_goals')) || { calories: 2000, protein: 150, carbs: 225, fat: 60, sugar: 50, sodium: 2300, potassium: 3500, water: 2500 };
                savedRecipes = JSON.parse(localStorage.getItem('fitTrackAI_savedRecipes')) || [];
                favoriteFoods = JSON.parse(localStorage.getItem('fitTrackAI_favoriteFoods')) || [];
            }

            // --- UI ELEMENT DEFINITIONS ---
            const ui = {
                foodNameInput: document.getElementById('food-name-input'), foodBrandInput: document.getElementById('food-brand-input'), foodServingsInput: document.getElementById('food-servings-input'), foodGramsInput: document.getElementById('food-grams-input'), logMealForm: document.getElementById('log-meal-form'), addFoodBtn: document.getElementById('add-food-btn'), addFoodError: document.getElementById('add-food-error'), dailyLogContentDiv: document.getElementById('daily-log-content'), aiSuggestionBtn: document.getElementById('ai-suggestion-btn'), aiSuggestionsOutput: document.getElementById('ai-suggestions-output'), scanFoodBtn: document.getElementById('scan-food-btn'), foodScannerModal: document.getElementById('food-scanner-modal'), closeFoodScannerModalBtn: document.getElementById('close-food-scanner-modal-btn'), uploadPhotoInput: document.getElementById('upload-photo-input'), scannerResultsContainer: document.getElementById('scanner-results-container'), foodScannerStatus: document.getElementById('food-scanner-status'), confirmModal: document.getElementById('confirm-modal'), confirmModalTitle: document.getElementById('confirm-modal-title'), confirmModalText: document.getElementById('confirm-modal-text'), confirmModalCancelBtn: document.getElementById('confirm-modal-cancel-btn'), confirmModalConfirmBtn: document.getElementById('confirm-modal-confirm-btn'), alertModal: document.getElementById('alert-modal'), alertModalTitle: document.getElementById('alert-modal-title'), alertModalText: document.getElementById('alert-modal-text'), alertModalOkBtn: document.getElementById('alert-modal-ok-btn'), createRecipeBtn: document.getElementById('create-recipe-btn'), compoundFoodModal: document.getElementById('compound-food-modal'), closeCompoundFoodModalBtn: document.getElementById('close-compound-food-modal-btn'), compoundFoodForm: document.getElementById('compound-food-form'), recipeNameInput: document.getElementById('recipe-name-input'), ingredientListContainer: document.getElementById('ingredient-list-container'), addIngredientBtn: document.getElementById('add-ingredient-btn'), saveRecipeBtn: document.getElementById('save-recipe-btn'), savedItemsListDiv: document.getElementById('saved-items-list'), promptModal: document.getElementById('prompt-modal'), promptModalTitle: document.getElementById('prompt-modal-title'), promptModalText: document.getElementById('prompt-modal-text'), promptModalInput: document.getElementById('prompt-modal-input'), promptModalCancelBtn: document.getElementById('prompt-modal-cancel-btn'), promptModalOkBtn: document.getElementById('prompt-modal-ok-btn'), editFavoriteModal: document.getElementById('edit-favorite-modal'), closeEditFavoriteModalBtn: document.getElementById('close-edit-favorite-modal-btn'), editFavoriteForm: document.getElementById('edit-favorite-form'), dailySummaryCard: document.getElementById('daily-summary-card'), dayViewTitleSpan: document.getElementById('day-view-title-span'), dayViewDateSpan: document.getElementById('day-view-date-span'), aiDailyReportBtn: document.getElementById('ai-daily-report-btn'), 
                aiReportModal: document.getElementById('ai-report-modal'), aiReportModalText: document.getElementById('ai-report-modal-text'), closeAiReportModalBtn: document.getElementById('close-ai-report-modal-btn'), aiReportModalOkBtn: document.getElementById('ai-report-modal-ok-btn'),
                addWaterBtn: document.getElementById('add-water-btn'),
                scanBarcodeBtn: document.getElementById('scan-barcode-btn'), barcodeScannerModal: document.getElementById('barcode-scanner-modal'), closeBarcodeScannerModalBtn: document.getElementById('close-barcode-scanner-modal-btn'), barcodeReader: document.getElementById('barcode-reader'), barcodeScannerStatus: document.getElementById('barcode-scanner-status'), barcodeResults: document.getElementById('barcode-results'),
                openNutritionistChatBtn: document.getElementById('open-nutritionist-chat-btn'), aiNutritionistModal: document.getElementById('ai-nutritionist-modal'), closeAiNutritionistModalBtn: document.getElementById('close-ai-nutritionist-modal-btn'), aiChatHistory: document.getElementById('ai-chat-history'), aiChatInput: document.getElementById('ai-chat-input'), aiChatSendBtn: document.getElementById('ai-chat-send-btn'),
                foodScannerInitialOptions: document.getElementById('food-scanner-initial-options'),
                liveCameraContainer: document.getElementById('live-camera-container'),
                startFoodCameraBtn: document.getElementById('start-food-camera-btn'),
                stopFoodCameraBtn: document.getElementById('stop-food-camera-btn'),
                captureFoodPhotoBtn: document.getElementById('capture-food-photo-btn'),
                foodCameraVideo: document.getElementById('food-camera-video'),
                foodCameraCanvas: document.getElementById('food-camera-canvas'),
            };

            // --- CHART.JS SETUP ---
            const macroCtx = document.getElementById('macro-chart').getContext('2d');
            let macroChart = new Chart(macroCtx, { type: 'doughnut', data: { labels: ['Protein', 'Carbs', 'Fat'], datasets: [{ data: [1, 1, 1], backgroundColor: ['#3b82f6', '#10b981', '#ef4444'], borderColor: 'var(--card-bg)', borderWidth: 5, hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false } } } });

            // --- RENDER & DATA FLOW FUNCTIONS ---
            function updateSummary() {
                const dayLog = getDayLog(viewDate);
                const currentDayLogEntries = dayLog.entries;

                const totals = currentDayLogEntries.reduce((acc, item) => { acc.calories += item.calories || 0; acc.protein += item.protein || 0; acc.carbs += item.carbs || 0; acc.fat += item.fat || 0; acc.sugar += item.sugar || 0; acc.sodium += item.sodium || 0; acc.potassium += item.potassium || 0; return acc; }, { calories: 0, protein: 0, carbs: 0, fat: 0, sugar: 0, sodium: 0, potassium: 0 });
                
                document.getElementById('current-calories').textContent = totals.calories.toFixed(0); document.getElementById('goal-calories').textContent = goals.calories;
                document.getElementById('current-protein').textContent = totals.protein.toFixed(1); document.getElementById('goal-protein').textContent = goals.protein;
                document.getElementById('current-carbs').textContent = totals.carbs.toFixed(1); document.getElementById('goal-carbs').textContent = goals.carbs;
                document.getElementById('current-fat').textContent = totals.fat.toFixed(1); document.getElementById('goal-fat').textContent = goals.fat;
                document.getElementById('current-sugar').textContent = totals.sugar.toFixed(1); document.getElementById('goal-sugar').textContent = goals.sugar;
                document.getElementById('current-sodium').textContent = totals.sodium.toFixed(0); document.getElementById('goal-sodium').textContent = goals.sodium;
                document.getElementById('current-potassium').textContent = totals.potassium.toFixed(0); document.getElementById('goal-potassium').textContent = goals.potassium;
                document.getElementById('current-water').textContent = dayLog.water; document.getElementById('goal-water').textContent = goals.water;
                
                const macroSum = totals.protein + totals.carbs + totals.fat;
                macroChart.data.datasets[0].data = macroSum > 0 ? [totals.protein, totals.carbs, totals.fat] : [1, 1, 1];
                macroChart.update();
            }

            function renderDailyLog() {
                const currentDayLogEntries = getCurrentDayLogEntries();
                if (currentDayLogEntries.length === 0) { ui.dailyLogContentDiv.innerHTML = '<p class="text-gray-500">No food logged yet.</p>'; return; }
                const isFavorite = (itemName) => favoriteFoods.some(fav => fav.name.toLowerCase() === itemName.toLowerCase()) || savedRecipes.some(rec => rec.name.toLowerCase() === itemName.toLowerCase());
                 ui.dailyLogContentDiv.innerHTML = currentDayLogEntries.map((item, index) => `
                    <div class="swipe-item rounded-lg" data-index="${index}" data-type="log" data-name="${item.name}">
                        <div class="swipe-actions">
                            <div class="swipe-action-container left"><div class="action delete"><i data-lucide="trash-2" class="pointer-events-none"></i><span class="ml-2 pointer-events-none">Delete</span></div></div>
                            <div class="swipe-action-container right"><div class="action edit"><span class="mr-2 pointer-events-none">Edit</span><i data-lucide="pencil" class="pointer-events-none"></i></div></div>
                        </div>
                        <div class="swipe-content p-3 rounded-lg">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-3">
                                    ${isFavorite(item.name) ? '<i data-lucide="star" class="w-4 h-4 text-yellow-400 fill-yellow-400 flex-shrink-0"></i>' : '<div class="w-4 h-4 flex-shrink-0"></div>'}
                                    <div>
                                        <p class="font-medium">${item.servings}x ${item.name} ${item.grams > 0 ? `(${item.grams.toFixed(0)}g)` : ''}</p>
                                        <p class="text-sm text-gray-400">${item.calories?.toFixed(0) || 0}kcal | ${item.protein?.toFixed(1) || 0}p | ${item.carbs?.toFixed(1) || 0}c | ${item.fat?.toFixed(1) || 0}f</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                lucide.createIcons();
            }
            
            function renderSavedItemsList() {
                const combinedList = [
                    ...savedRecipes.map((item, index) => ({...item, type: 'recipe', originalIndex: index})),
                    ...favoriteFoods.map((item, index) => ({...item, type: 'food', originalIndex: index}))
                ].sort((a,b) => a.name.localeCompare(b.name));

                if (combinedList.length === 0) {
                    ui.savedItemsListDiv.innerHTML = '<p class="text-gray-500 text-center">No saved items yet.</p>';
                    return;
                }
                const isFavorite = (itemName) => favoriteFoods.some(fav => fav.name.toLowerCase() === itemName.toLowerCase()) || savedRecipes.some(rec => rec.name.toLowerCase() === itemName.toLowerCase());
                
                ui.savedItemsListDiv.innerHTML = combinedList.map(item => `
                    <div class="swipe-item rounded-lg" data-name="${item.name}" data-type="${item.type}" data-index="${item.originalIndex}">
                         <div class="swipe-actions">
                            <div class="swipe-action-container left"><div class="action delete"><i data-lucide="trash-2" class="pointer-events-none"></i><span class="ml-2 pointer-events-none">Delete</span></div></div>
                            <div class="swipe-action-container right"><div class="action edit"><span class="mr-2 pointer-events-none">Edit</span><i data-lucide="pencil" class="pointer-events-none"></i></div></div>
                        </div>
                        <div class="swipe-content p-3 rounded-lg">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-3">
                                   ${isFavorite(item.name) ? '<i data-lucide="star" class="w-4 h-4 text-yellow-400 fill-yellow-400 flex-shrink-0"></i>' : '<div class="w-4 h-4 flex-shrink-0"></div>'}
                                   <p class="font-medium">${item.name}</p>
                                   ${item.type === 'recipe' ? '<span class="text-xs bg-blue-500 text-white rounded-full px-2 py-0.5">Recipe</span>' : ''}
                                </div>
                                <button class="log-item-btn btn btn-secondary !p-2" title="Log Item"><i data-lucide="plus" class="w-4 h-4 pointer-events-none"></i></button>
                            </div>
                        </div>
                    </div>`).join('');
                lucide.createIcons();
            }


            function fullRender() {
                updateSummary();
                renderDailyLog();
                renderSavedItemsList();
                lucide.createIcons();
            }

            function addIngredientRow(ingredient = null) {
                const div = document.createElement('div');
                div.className = 'ingredient-row space-y-3 border border-border-color p-4 rounded-lg';
                div.innerHTML = `
                    <div class="grid grid-cols-12 gap-2 items-center">
                        <input type="text" list="favorite-foods-datalist" placeholder="Ingredient Name" class="form-input col-span-12 sm:col-span-6 ingredient-name" value="${ingredient ? ingredient.name : ''}">
                        <input type="number" placeholder="grams" min="0" class="form-input col-span-6 sm:col-span-3 ingredient-grams" value="${ingredient ? ingredient.grams : ''}">
                        <div class="col-span-6 sm:col-span-3 flex justify-end gap-1">
                            <button type="button" class="recipe-ai-btn btn btn-secondary !p-2" title="Scan with AI"><i data-lucide="camera" class="w-4 h-4 pointer-events-none"></i></button>
                            <button type="button" class="recipe-barcode-btn btn btn-secondary !p-2" title="Scan Barcode"><i data-lucide="barcode" class="w-4 h-4 pointer-events-none"></i></button>
                            <button type="button" class="remove-ingredient-btn btn btn-secondary !p-2" title="Remove Ingredient"><i data-lucide="x" class="w-4 h-4 pointer-events-none"></i></button>
                        </div>
                    </div>
                     <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <input type="number" step="0.01" min="0" placeholder="kcal" class="form-input ingredient-calories" value="${ingredient ? ingredient.calories : ''}">
                        <input type="number" step="0.01" min="0" placeholder="protein" class="form-input ingredient-protein" value="${ingredient ? ingredient.protein : ''}">
                        <input type="number" step="0.01" min="0" placeholder="carbs" class="form-input ingredient-carbs" value="${ingredient ? ingredient.carbs : ''}">
                        <input type="number" step="0.01" min="0" placeholder="fat" class="form-input ingredient-fat" value="${ingredient ? ingredient.fat : ''}">
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                         <input type="number" step="0.01" min="0" placeholder="sugar" class="form-input ingredient-sugar" value="${ingredient ? ingredient.sugar : ''}">
                         <input type="number" step="0.01" min="0" placeholder="sodium" class="form-input ingredient-sodium" value="${ingredient ? ingredient.sodium : ''}">
                         <input type="number" step="0.01" min="0" placeholder="potassium" class="form-input ingredient-potassium" value="${ingredient ? ingredient.potassium : ''}">
                    </div>
                `;
                ui.ingredientListContainer.appendChild(div);
                lucide.createIcons();
            }

            function updateRecipeTotals() {
                let totalCalories = 0, totalProtein = 0, totalCarbs = 0, totalFat = 0, totalGrams = 0, totalSugar = 0, totalSodium = 0, totalPotassium = 0;
                document.querySelectorAll('.ingredient-row').forEach(row => {
                    const grams = parseFloat(row.querySelector('.ingredient-grams').value) || 0;
                    if (grams > 0) {
                        totalGrams += grams;
                        totalCalories += parseFloat(row.querySelector('.ingredient-calories').value) || 0;
                        totalProtein += parseFloat(row.querySelector('.ingredient-protein').value) || 0;
                        totalCarbs += parseFloat(row.querySelector('.ingredient-carbs').value) || 0;
                        totalFat += parseFloat(row.querySelector('.ingredient-fat').value) || 0;
                        totalSugar += parseFloat(row.querySelector('.ingredient-sugar').value) || 0;
                        totalSodium += parseFloat(row.querySelector('.ingredient-sodium').value) || 0;
                        totalPotassium += parseFloat(row.querySelector('.ingredient-potassium').value) || 0;
                    }
                });
                document.getElementById('recipe-total-calories').textContent = totalCalories.toFixed(0);
                document.getElementById('recipe-total-protein').textContent = totalProtein.toFixed(1);
                document.getElementById('recipe-total-carbs').textContent = totalCarbs.toFixed(1);
                document.getElementById('recipe-total-fat').textContent = totalFat.toFixed(1);
                document.getElementById('recipe-total-sugar').textContent = totalSugar.toFixed(1);
                document.getElementById('recipe-total-sodium').textContent = totalSodium.toFixed(0);
                document.getElementById('recipe-total-potassium').textContent = totalPotassium.toFixed(0);
                document.getElementById('recipe-total-grams').textContent = totalGrams.toFixed(1);
            }
            
            async function getDailyLogAIReport() {
                const btn = ui.aiDailyReportBtn, btnText = btn.querySelector('.btn-text'), loader = btn.querySelector('.loader');
                const dateKey = dateToKey(viewDate), currentLog = getCurrentDayLogEntries();
                if (currentLog.length === 0) { showCustomAlert('No Data', `There is no food logged for ${dateKey}.`); return; }
                const totals = currentLog.reduce((acc, item) => { acc.calories += item.calories || 0; acc.protein += item.protein || 0; acc.carbs += item.carbs || 0; acc.fat += item.fat || 0; acc.sugar += item.sugar || 0; acc.sodium += item.sodium || 0; acc.potassium += item.potassium || 0; return acc; }, { calories: 0, protein: 0, carbs: 0, fat: 0, sugar: 0, sodium: 0, potassium: 0 });
                const goalData = goals;
                btn.disabled = true; btnText.style.display = 'none'; loader.classList.remove('hidden');
                
                ui.aiReportModalText.textContent = 'Generating personalized report...';
                showModal(ui.aiReportModal);

                const systemPrompt = `You are a friendly but expert nutrition coach. Provide a brief, actionable analysis of the user's daily food log. 1. Analyze the logged data against the goals. 2. Evaluate macro distribution (Protein, Carbs, Fat) and key micronutrients (Sodium/Potassium/Sugar). 3. Provide a concise summary (1-2 sentences). 4. Offer one specific, actionable tip for improvement/maintenance based on the biggest deviation or goal. Keep the report readable, using markdown bold for key stats, and keep the total response under 100 words.`;
                const userQuery = `Analyze the following log data for ${dateKey}: --- Logged Data --- Total Calories: ${totals.calories.toFixed(0)} kcal, Protein: ${totals.protein.toFixed(1)} g, Carbs: ${totals.carbs.toFixed(1)} g, Fat: ${totals.fat.toFixed(1)} g, Sugar: ${totals.sugar.toFixed(1)} g, Sodium: ${totals.sodium.toFixed(0)} mg, Potassium: ${totals.potassium.toFixed(0)} mg. --- Daily Goals --- Calorie Goal: ${goalData.calories} kcal, Protein Goal: ${goalData.protein} g, Carb Goal: ${goalData.carbs} g, Fat Goal: ${goalData.fat} g, Sugar Limit: ${goalData.sugar} g, Sodium Limit: ${goalData.sodium} mg, Potassium Target: ${goalData.potassium} mg`;
                const apiUrl = getApiUrl('gemini-2.5-flash-preview-05-20');
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } }) });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const result = await response.json(); let text = result.candidates[0].content.parts[0].text;
                    ui.aiReportModalText.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                } catch (error) { console.error("AI Report Error:", error); ui.aiReportModalText.textContent = 'Sorry, the AI coach is unavailable right now.'; ui.aiReportModalText.classList.add('text-red-400');
                } finally { btn.disabled = false; btnText.style.display = 'inline'; loader.classList.add('hidden'); }
            }

            function updateDayView(date) {
                viewDate = date; const today = new Date(); today.setHours(0, 0, 0, 0);
                const dateKey = dateToKey(date), isToday = dateKey === dateToKey(today);
                ui.dayViewTitleSpan.textContent = isToday ? 'Today' : date.toLocaleDateString(undefined, { weekday: 'long' });
                ui.dayViewDateSpan.textContent = date.toLocaleDateString(undefined, { month: 'long', day: 'numeric' });
                fullRender();
            }
            
            async function getMacrosFromAI(foodName, brand) {
                let prompt = `Provide nutritional information for a standard single serving of "${foodName}"`;
                if (brand) prompt += ` from the brand "${brand}"`;
                prompt += `. Respond with only a valid JSON object containing all fields for ONE standard serving: "servingGrams", "calories", "protein", "carbs", "fat", "sugar", "sodium", "potassium". If it's a food that is hard to quantify, like "salad", provide a reasonable estimate for a typical side-salad portion.`;

                const apiUrl = getApiUrl('gemini-2.5-flash-preview-05-20');
                const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } };
                for (let i = 0; i < 3; i++) {
                    try {
                        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        if (response.ok) { const result = await response.json(); if (!result.candidates) throw new Error("Invalid API response."); return JSON.parse(result.candidates[0].content.parts[0].text); }
                        if (response.status === 429) await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                        else throw new Error(`API Error: ${response.status}`);
                    } catch (error) { if (i === 2) throw error; await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000)); }
                }
                throw new Error("API call failed after retries.");
            }
            
            function toggleFavorite(itemName) {
                if (savedRecipes.some(r => r.name.toLowerCase() === itemName.toLowerCase())) { 
                    showCustomAlert("Action Not Allowed", "Recipes are automatically favorited and cannot be unfavorited."); 
                    return; 
                }
                const favIndex = favoriteFoods.findIndex(fav => fav.name.toLowerCase() === itemName.toLowerCase());
                if (favIndex > -1) { 
                    favoriteFoods.splice(favIndex, 1); 
                } else { 
                     const logItem = getCurrentDayLogEntries().find(item => item.name.toLowerCase() === itemName.toLowerCase()) || savedRecipes.find(item => item.name.toLowerCase() === itemName.toLowerCase());
                     if (!logItem) {
                         showCustomAlert("Error", "Could not find item to favorite.");
                         return;
                     }
                    const totalGrams = logItem.grams || 0; 
                    if (totalGrams <= 0) { 
                        showCustomAlert("Cannot Favorite", "Cannot favorite an item with 0 grams to calculate base macros."); 
                        return; 
                    } 
                    const ratio = 100 / totalGrams; 
                    favoriteFoods.push({ name: logItem.name, calories: logItem.calories * ratio, protein: logItem.protein * ratio, carbs: logItem.carbs * ratio, fat: logItem.fat * ratio, }); 
                }
                saveData(); 
                fullRender();
            }

            // --- EVENT LISTENERS ---
            ui.addFoodBtn.addEventListener('click', async () => {
                ui.addFoodError.textContent = '';
                const btn = ui.addFoodBtn;
                const btnText = btn.querySelector('.btn-text');
                const loader = btn.querySelector('.loader');

                const foodName = ui.foodNameInput.value.trim();
                const servings = parseFloat(ui.foodServingsInput.value);
                
                if (!foodName || isNaN(servings) || servings <= 0) {
                    ui.addFoodError.textContent = "Please enter a valid food name and serving amount.";
                    return;
                }

                let singleServingMacros = {};
                let hasManualMacros = false;
                let hasError = false;

                ['calories', 'protein', 'carbs', 'fat', 'sugar', 'sodium', 'potassium'].forEach(m => {
                    const input = document.getElementById(`food-${m}-input`);
                    const val = parseFloat(input.value);
                    if (!isNaN(val) && val < 0) {
                        ui.addFoodError.textContent = "Macro values cannot be negative.";
                        input.classList.add('!border-red-500');
                        hasError = true;
                    } else {
                        input.classList.remove('!border-red-500');
                        singleServingMacros[m] = val || 0;
                    }
                });

                if (singleServingMacros.calories > 0) hasManualMacros = true;
                if (hasError) return;
                
                let servingGrams = parseFloat(ui.foodGramsInput.value) || 0;

                if (!hasManualMacros && editingFoodLogIndex === null) {
                    btn.disabled = true;
                    btnText.style.display = 'none';
                    loader.classList.remove('hidden');
                    try {
                        const brand = ui.foodBrandInput.value.trim();
                        const data = await getMacrosFromAI(foodName, brand);
                        servingGrams = data.servingGrams || 0;
                        singleServingMacros = { calories: data.calories, protein: data.protein, carbs: data.carbs, fat: data.fat, sugar: data.sugar, sodium: data.sodium, potassium: data.potassium };
                    } catch (error) {
                        console.error("AI Get Macros Error:", error);
                        ui.addFoodError.textContent = "Could not fetch nutrition data.";
                        btn.disabled = false;
                        btnText.style.display = 'inline';
                        loader.classList.add('hidden');
                        return;
                    } finally {
                        btn.disabled = false;
                        btnText.style.display = 'inline';
                        loader.classList.add('hidden');
                    }
                }
                
                const dayLog = getDayLog(viewDate);
                
                const totalMacros = {
                    calories: (singleServingMacros.calories || 0) * servings,
                    protein: (singleServingMacros.protein || 0) * servings,
                    carbs: (singleServingMacros.carbs || 0) * servings,
                    fat: (singleServingMacros.fat || 0) * servings,
                    sugar: (singleServingMacros.sugar || 0) * servings,
                    sodium: (singleServingMacros.sodium || 0) * servings,
                    potassium: (singleServingMacros.potassium || 0) * servings,
                };

                const foodItem = { name: foodName, brand: ui.foodBrandInput.value.trim(), servings, grams: servingGrams * servings, ...totalMacros };

                if (editingFoodLogIndex !== null) {
                    dayLog.entries[editingFoodLogIndex] = foodItem;
                    editingFoodLogIndex = null;
                    ui.addFoodBtn.querySelector('.btn-text').textContent = 'Add Food';
                } else {
                    dayLog.entries.push(foodItem);
                }

                ui.logMealForm.reset();
                ui.foodServingsInput.value = 1;
                saveData();
                updateDayView(viewDate);
            });
            
            ui.addWaterBtn.addEventListener('click', () => {
                const waterServingSize = userProfile.waterServingSize || 250;
                const dayLog = getDayLog(viewDate);
                dayLog.water += waterServingSize;
                saveData();
                updateDayView(viewDate);
            });
            
             const handleEditLogItem = (index) => {
                const item = getCurrentDayLogEntries()[index];
                if(!item) return;

                editingFoodLogIndex = index;
                ui.foodNameInput.value = item.name;
                ui.foodServingsInput.value = item.servings;
                
                const singleServingGrams = item.grams / item.servings;
                const singleServingCalories = item.calories / item.servings;

                if (singleServingGrams) ui.foodGramsInput.value = singleServingGrams.toFixed(1);
                
                if(singleServingCalories) {
                    document.getElementById('food-calories-input').value = (item.calories / item.servings).toFixed(2);
                    document.getElementById('food-protein-input').value = (item.protein / item.servings).toFixed(2);
                    document.getElementById('food-carbs-input').value = (item.carbs / item.servings).toFixed(2);
                    document.getElementById('food-fat-input').value = (item.fat / item.servings).toFixed(2);
                    document.getElementById('food-sugar-input').value = (item.sugar / item.servings).toFixed(2);
                    document.getElementById('food-sodium-input').value = (item.sodium / item.servings).toFixed(2);
                    document.getElementById('food-potassium-input').value = (item.potassium / item.servings).toFixed(2);
                }


                ui.addFoodBtn.querySelector('.btn-text').textContent = 'Update Food';
                ui.logMealForm.scrollIntoView({ behavior: 'smooth' });
            };
            
            const handleDeleteLogItem = (index) => {
                showConfirmModal('Delete Log Entry?', 'Are you sure?', () => {
                    let dayLog = getDayLog(viewDate);
                    if (dayLog && dayLog.entries) {
                        dayLog.entries.splice(index, 1);
                        saveData();
                        updateDayView(viewDate);
                    }
                });
            };

            ui.aiDailyReportBtn.addEventListener('click', getDailyLogAIReport);
            ui.closeAiReportModalBtn.addEventListener('click', () => hideModal(ui.aiReportModal));
            ui.aiReportModalOkBtn.addEventListener('click', () => hideModal(ui.aiReportModal));
            
            ['food-name-input', 'food-brand-input'].forEach(id => document.getElementById(id).addEventListener('input', () => { aiBaseMacros = null; }));

            ui.aiSuggestionBtn.addEventListener('click', async () => {
                const btn = ui.aiSuggestionBtn, btnText = btn.querySelector('.btn-text'), loader = btn.querySelector('.loader');
                const ingredients = document.getElementById('ai-ingredients').value.trim();
                if (!ingredients) { ui.aiSuggestionsOutput.innerHTML = `<p class="text-yellow-400">Please enter some ingredients.</p>`; return; }
                btn.disabled = true; btnText.style.display = 'none'; loader.classList.remove('hidden'); ui.aiSuggestionsOutput.innerHTML = '';
                const currentDayLogEntries = getCurrentDayLogEntries();
                const remainingCalories = Math.max(0, goals.calories - currentDayLogEntries.reduce((sum, item) => sum + item.calories, 0));
                const prompt = `I have: ${ingredients}. I have about ${remainingCalories} calories left. My goal is ${userProfile.goal}. Suggest one simple, healthy meal. Provide the name, prep/cook time, and simple step-by-step instructions. Format with Markdown.`;
                const apiUrl = getApiUrl('gemini-2.5-flash-preview-05-20');
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const result = await response.json(); let text = result.candidates[0].content.parts[0].text;
                    text = text.replace(/\*\*(.*?)\*\*/g, '<h3 class="text-lg font-semibold mt-4 mb-2">$1</h3>').replace(/\*/g, '').replace(/(\d+\.)/g, '<br>$1');
                    ui.aiSuggestionsOutput.innerHTML = `<div class="bg-black/30 p-4 rounded-lg text-sm">${text}</div>`;
                } catch (error) { console.error("AI Suggestion Error:", error); ui.aiSuggestionsOutput.innerHTML = `<p class="text-red-400">Could not get a suggestion.</p>`;
                } finally { btn.disabled = false; btnText.style.display = 'inline'; loader.classList.add('hidden'); }
            });
            
            function fileToGenerativePart(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onloadend = () => { const base64Data = reader.result.split(',')[1]; resolve({ inlineData: { mimeType: file.type, data: base64Data } }); }; reader.onerror = (err) => reject(err); reader.readAsDataURL(file); }); }
            
            // --- UPDATED FOOD SCANNER ---
            
            async function startFoodCamera() {
                ui.foodScannerInitialOptions.classList.add('hidden');
                ui.liveCameraContainer.classList.remove('hidden');
                ui.foodScannerStatus.textContent = 'Starting camera...';
                try {
                    foodCameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                    ui.foodCameraVideo.srcObject = foodCameraStream;
                    ui.foodScannerStatus.textContent = 'Camera active. Point and capture.';
                } catch (err) {
                    console.error("Camera access error:", err);
                    ui.foodScannerStatus.textContent = 'Could not access camera.';
                    stopFoodCamera();
                }
            }

            function stopFoodCamera() {
                if (foodCameraStream) {
                    foodCameraStream.getTracks().forEach(track => track.stop());
                }
                foodCameraStream = null;
                ui.liveCameraContainer.classList.add('hidden');
                ui.foodScannerInitialOptions.classList.remove('hidden');
                ui.foodScannerStatus.textContent = '';
            }

            function captureFoodPhoto() {
                const video = ui.foodCameraVideo;
                const canvas = ui.foodCameraCanvas;
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const context = canvas.getContext('2d');
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                canvas.toBlob(blob => {
                    if (blob) {
                        const file = new File([blob], `capture-${Date.now()}.jpg`, { type: 'image/jpeg' });
                        handleImageFiles([file]);
                    }
                }, 'image/jpeg', 0.9);
            }
            
            ui.scanFoodBtn.addEventListener('click', () => { 
                scanningIngredientRow = null; 
                ui.scannerResultsContainer.innerHTML = '';
                ui.foodScannerStatus.textContent = '';
                // Reset to initial state
                ui.liveCameraContainer.classList.add('hidden');
                ui.foodScannerInitialOptions.classList.remove('hidden');
                showModal(ui.foodScannerModal); 
            });

            ui.closeFoodScannerModalBtn.addEventListener('click', () => {
                stopFoodCamera();
                hideModal(ui.foodScannerModal);
            });
            
            ui.startFoodCameraBtn.addEventListener('click', startFoodCamera);
            ui.stopFoodCameraBtn.addEventListener('click', stopFoodCamera);
            ui.captureFoodPhotoBtn.addEventListener('click', captureFoodPhoto);


            async function processImageWithAI(file, resultElement) {
                try {
                    const imagePart = await fileToGenerativePart(file);
                    let prompt = `Identify the food in this image. Respond ONLY with a valid JSON object with these fields: "name", "brand", "servings" (estimated number of standard servings shown), "totalGrams" (estimated total grams for all servings shown), "calories", "protein", "carbs", "fat", "sugar", "sodium", "potassium". The nutritional values (calories, protein, etc.) should be for the TOTAL amount of food pictured.`;
                    const apiUrl = getApiUrl('gemini-2.5-flash-preview-05-20');
                    const payload = { contents: [{ parts: [{ text: prompt }, imagePart] }], generationConfig: { responseMimeType: "application/json" } };
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const result = await response.json();
                    if (!result.candidates?.[0].content.parts[0].text) throw new Error("Invalid API response.");
                    
                    const data = JSON.parse(result.candidates[0].content.parts[0].text);
                    resultElement.querySelector('.loader').remove();

                    const detailsDiv = document.createElement('div');
                    detailsDiv.className = 'text-xs text-gray-400';
                    detailsDiv.innerHTML = `
                        <p class="font-bold text-sm text-white mb-1">${data.name || 'Unknown Food'} (${(data.servings || 1).toFixed(1)} serv.)</p>
                        <p>${data.totalGrams?.toFixed(0) || '?'}g | ${data.calories?.toFixed(0) || '?'} kcal</p>
                        <p>${data.protein?.toFixed(1) || '?'}p | ${data.carbs?.toFixed(1) || '?'}c | ${data.fat?.toFixed(1) || '?'}f</p>
                    `;
                    
                    const logButton = document.createElement('button');
                    logButton.className = 'btn btn-primary !p-2 mt-2 w-full';
                    logButton.innerHTML = 'Log this';
                    logButton.onclick = () => {
                        const foodItem = {
                            name: data.name || 'Scanned Food',
                            brand: data.brand || '',
                            servings: data.servings || 1,
                            grams: data.totalGrams || 0,
                            calories: data.calories || 0,
                            protein: data.protein || 0,
                            carbs: data.carbs || 0,
                            fat: data.fat || 0,
                            sugar: data.sugar || 0,
                            sodium: data.sodium || 0,
                            potassium: data.potassium || 0,
                        };
                        const dayLog = getDayLog(viewDate);
                        dayLog.entries.push(foodItem);
                        saveData();
                        updateDayView(viewDate);
                        logButton.textContent = 'Logged!';
                        logButton.disabled = true;
                        showCustomAlert('Success', `${foodItem.name} has been added to your log.`);
                    };

                    resultElement.appendChild(detailsDiv);
                    resultElement.appendChild(logButton);

                } catch (error) {
                    console.error("AI Image Scan Error:", error);
                    resultElement.querySelector('.loader').remove();
                    resultElement.innerHTML += `<p class="text-red-400 text-xs">Error analyzing.</p>`;
                }
            }

            function handleImageFiles(files) {
                if (!files || files.length === 0) return;
                
                for(const file of files) {
                    const resultElement = document.createElement('div');
                    resultElement.className = 'p-3 bg-input-bg rounded-lg text-center';
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        resultElement.innerHTML = `
                            <img src="${e.target.result}" class="w-full h-24 object-cover rounded-md mb-2">
                            <div class="loader mx-auto"></div>
                        `;
                    };
                    reader.readAsDataURL(file);
                    ui.scannerResultsContainer.appendChild(resultElement);
                    processImageWithAI(file, resultElement);
                }
            }

            ui.uploadPhotoInput.addEventListener('change', (e) => handleImageFiles(e.target.files));
            
            ui.createRecipeBtn.addEventListener('click', () => {
                editingRecipeIndex = null; ui.compoundFoodModal.querySelector('h2').textContent = "Create a Recipe";
                ui.saveRecipeBtn.textContent = "Save & Log Recipe"; ui.compoundFoodForm.reset();
                ui.ingredientListContainer.innerHTML = ''; addIngredientRow(); addIngredientRow();
                updateRecipeTotals(); showModal(ui.compoundFoodModal);
            });
            
            ui.addIngredientBtn.addEventListener('click', () => addIngredientRow());
            
            ui.ingredientListContainer.addEventListener('input', updateRecipeTotals);
            ui.ingredientListContainer.addEventListener('click', async (e) => {
                 const aiBtn = e.target.closest('.recipe-ai-btn'); const removeBtn = e.target.closest('.remove-ingredient-btn'); const barcodeBtn = e.target.closest('.recipe-barcode-btn');
                const row = e.target.closest('.ingredient-row');
                if (removeBtn) { removeBtn.closest('.ingredient-row').remove(); updateRecipeTotals(); }
                if (barcodeBtn) { scanningIngredientRow = row; startBarcodeScanner(); }
                if (aiBtn) { 
                    scanningIngredientRow = row; 
                    ui.scannerResultsContainer.innerHTML = '';
                    ui.foodScannerStatus.textContent = '';
                    ui.liveCameraContainer.classList.add('hidden');
                    ui.foodScannerInitialOptions.classList.remove('hidden');
                    showModal(ui.foodScannerModal); 
                }
            });
            
            ui.compoundFoodForm.addEventListener('submit', (e) => {
                e.preventDefault(); const name = ui.recipeNameInput.value.trim();
                if(!name) { showCustomAlert('Missing Name', 'Please give your recipe a name.'); return; }
                const ingredients = []; let totalGrams = 0, totalCalories = 0, totalProtein = 0, totalCarbs = 0, totalFat = 0, totalSugar = 0, totalSodium = 0, totalPotassium = 0;
                document.querySelectorAll('.ingredient-row').forEach(row => {
                    const ingName = row.querySelector('.ingredient-name').value.trim(); const ingGrams = parseFloat(row.querySelector('.ingredient-grams').value) || 0;
                    if(ingName && ingGrams > 0) {
                        const ing = { name: ingName, grams: ingGrams, calories: parseFloat(row.querySelector('.ingredient-calories').value) || 0, protein: parseFloat(row.querySelector('.ingredient-protein').value) || 0, carbs: parseFloat(row.querySelector('.ingredient-carbs').value) || 0, fat: parseFloat(row.querySelector('.ingredient-fat').value) || 0, sugar: parseFloat(row.querySelector('.ingredient-sugar').value) || 0, sodium: parseFloat(row.querySelector('.ingredient-sodium').value) || 0, potassium: parseFloat(row.querySelector('.ingredient-potassium').value) || 0, };
                        ingredients.push(ing); totalGrams += ing.grams; totalCalories += ing.calories; totalProtein += ing.protein; totalCarbs += ing.carbs; totalFat += ing.fat; totalSugar += ing.sugar; totalSodium += ing.sodium; totalPotassium += ing.potassium;
                    }
                });
                if(ingredients.length === 0) { showCustomAlert('No Ingredients', 'Add at least one ingredient to the recipe.'); return; }
                const newRecipe = { name, ingredients, totalGrams, calories: totalCalories, protein: totalProtein, carbs: totalCarbs, fat: totalFat, sugar: totalSugar, sodium: totalSodium, potassium: totalPotassium };
                
                if (editingRecipeIndex !== null) {
                    const oldRecipeName = savedRecipes[editingRecipeIndex].name;
                    const oldFavIndex = favoriteFoods.findIndex(f => f.name.toLowerCase() === oldRecipeName.toLowerCase());
                    if (oldFavIndex > -1) favoriteFoods.splice(oldFavIndex, 1);
                    savedRecipes[editingRecipeIndex] = newRecipe;
                } else {
                    savedRecipes.push(newRecipe); 
                    const dayLog = getDayLog(viewDate); 
                    const logEntry = { ...newRecipe, servings: 1, grams: totalGrams }; 
                    dayLog.entries.push(logEntry); 
                }

                if (newRecipe.totalGrams > 0) {
                    const ratio = 100 / newRecipe.totalGrams;
                    const recipeAsFavorite = { name: newRecipe.name, calories: newRecipe.calories * ratio, protein: newRecipe.protein * ratio, carbs: newRecipe.carbs * ratio, fat: newRecipe.fat * ratio };
                    const existingFavIndex = favoriteFoods.findIndex(f => f.name.toLowerCase() === newRecipe.name.toLowerCase());
                    if (existingFavIndex > -1) favoriteFoods.splice(existingFavIndex, 1);
                    favoriteFoods.push(recipeAsFavorite);
                }

                saveData(); updateDayView(viewDate); hideModal(ui.compoundFoodModal); showCustomAlert('Success', `Recipe "${name}" has been saved.`);
            });
            
            ui.savedItemsListDiv.addEventListener('click', (e) => {
                 const logBtn = e.target.closest('.log-item-btn');
                if(!logBtn) return;
                const container = logBtn.closest('.swipe-item');
                const type = container.dataset.type;
                const index = parseInt(container.dataset.index);

                if (type === 'food') {
                    const food = favoriteFoods[index]; if (!food) return;
                    showPromptModal(`Log Food: ${food.name}`, `How many grams of ${food.name}?`, "100", (weightStr) => {
                        if (weightStr === null) return; const grams = parseFloat(weightStr); if (isNaN(grams) || grams <= 0) { showCustomAlert('Invalid Input', 'Please enter a valid number for grams.'); return; }
                        const ratio = grams / 100; const foodItem = { name: food.name, servings: 1, grams, calories: food.calories * ratio, protein: food.protein * ratio, carbs: food.carbs * ratio, fat: food.fat * ratio, };
                        const dayLog = getDayLog(viewDate); 
                        dayLog.entries.push(foodItem);
                        saveData(); updateDayView(viewDate); showCustomAlert('Success', `${grams}g of ${food.name} added to the log.`);
                    });
                } else if (type === 'recipe') {
                    const recipe = savedRecipes[index]; if (!recipe) return;
                    showPromptModal(`Log Recipe: ${recipe.name}`, `How many grams of ${recipe.name}?`, recipe.totalGrams.toFixed(0), (weightStr) => {
                        if (weightStr === null) return; const grams = parseFloat(weightStr); if (isNaN(grams) || grams <= 0) { showCustomAlert('Invalid Input', 'Please enter a valid number for grams.'); return; }
                        const ratio = recipe.totalGrams > 0 ? grams / recipe.totalGrams : 0; const foodItem = { name: recipe.name, servings: 1, grams, calories: recipe.calories * ratio, protein: recipe.protein * ratio, carbs: recipe.carbs * ratio, fat: recipe.fat * ratio, sugar: recipe.sugar * ratio, sodium: recipe.sodium * ratio, potassium: recipe.potassium * ratio, };
                        const dayLog = getDayLog(viewDate);
                        dayLog.entries.push(foodItem); 
                        saveData(); updateDayView(viewDate); showCustomAlert('Success', `${grams}g of ${recipe.name} added to the log.`);
                    });
                }
            });

            ui.editFavoriteForm.addEventListener('submit', (e) => {
                e.preventDefault(); const favIndex = favoriteFoods.findIndex(f => f.name === editingFavoriteFoodName); if (favIndex === -1) return;
                const newName = document.getElementById('edit-fav-food-name').value.trim();
                if (newName.toLowerCase() !== editingFavoriteFoodName.toLowerCase() && (favoriteFoods.some(f => f.name.toLowerCase() === newName.toLowerCase()) || savedRecipes.some(r => r.name.toLowerCase() === newName.toLowerCase()))) { showCustomAlert('Name Exists', 'A favorite food or recipe with this name already exists.'); return; }
                favoriteFoods[favIndex].name = newName; favoriteFoods[favIndex].calories = parseFloat(document.getElementById('edit-fav-food-calories').value); favoriteFoods[favIndex].protein = parseFloat(document.getElementById('edit-fav-food-protein').value); favoriteFoods[favIndex].carbs = parseFloat(document.getElementById('edit-fav-food-carbs').value); favoriteFoods[favIndex].fat = parseFloat(document.getElementById('edit-fav-food-fat').value);
                saveData(); fullRender(); hideModal(ui.editFavoriteModal);
            });


            // OTHER MODAL LISTENERS
            ui.closeEditFavoriteModalBtn.addEventListener('click', () => hideModal(ui.editFavoriteModal));
            ui.closeCompoundFoodModalBtn.addEventListener('click', () => hideModal(ui.compoundFoodModal));
            ui.alertModalOkBtn.addEventListener('click', () => hideModal(ui.alertModal));
            ui.confirmModalCancelBtn.addEventListener('click', () => hideModal(ui.confirmModal));
            ui.confirmModalConfirmBtn.addEventListener('click', () => { if (confirmCallback) confirmCallback(); hideModal(ui.confirmModal); });
            ui.promptModalCancelBtn.addEventListener('click', () => hideModal(ui.promptModal));
            ui.promptModalOkBtn.addEventListener('click', () => { if(promptCallback) promptCallback(ui.promptModalInput.value); hideModal(ui.promptModal); });

            // BARCODE LISTENERS
            const startBarcodeScanner = () => {
                showModal(ui.barcodeScannerModal);
                document.getElementById('barcode-initial-options')?.classList.remove('hidden');
                ui.barcodeReader.classList.add('hidden');
                ui.barcodeResults.innerHTML = '';
                ui.barcodeScannerStatus.textContent = 'Choose an option to scan a barcode.';
            };
            
            const stopBarcodeScanner = () => {
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().then(() => {}).catch(err => {});
                }
                 hideModal(ui.barcodeScannerModal);
            };

            const initiateLiveScanner = () => {
                const initialOptions = document.getElementById('barcode-initial-options');
                if(initialOptions) initialOptions.classList.add('hidden');
                ui.barcodeReader.classList.remove('hidden');
                ui.barcodeScannerStatus.textContent = "Starting camera...";

                if (html5QrCode && html5QrCode.isScanning) { html5QrCode.stop(); }
                html5QrCode = new Html5Qrcode("barcode-reader");
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };

                html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                    .catch(err => {
                        ui.barcodeScannerStatus.innerHTML = `Camera permission denied. <br>Please allow camera access or use the upload option.`;
                        setTimeout(() => {
                             if(initialOptions) initialOptions.classList.remove('hidden');
                             ui.barcodeReader.classList.add('hidden');
                             ui.barcodeScannerStatus.textContent = 'Choose an option to scan a barcode.';
                        }, 3000);
                    });
            };
            
            async function onScanSuccess(decodedText, decodedResult) {
                const now = Date.now();
                if (decodedText === lastScannedBarcode.code && (now - lastScannedBarcode.time) < 3000) {
                    return; // Ignore rapid duplicate scans
                }
                lastScannedBarcode = { code: decodedText, time: now };

                ui.barcodeScannerStatus.textContent = `Found: ${decodedText}. Fetching...`;

                try {
                    const response = await fetch(`https://world.openfoodfacts.org/api/v2/product/${decodedText}?fields=product_name,brands,nutriments,serving_size,quantity`);
                    if(!response.ok) throw new Error('Product not found in Open Food Facts database.');
                    const data = await response.json();
                    if(data.status === 0) throw new Error(data.status_verbose);
                    const product = data.product, nutriments = product.nutriments;
                    
                    aiBaseMacros = {
                        baseGrams: 100,
                        calories: nutriments['energy-kcal_100g'] || 0, protein: nutriments.proteins_100g || 0, carbs: nutriments.carbohydrates_100g || 0, fat: nutriments.fat_100g || 0, sugar: nutriments.sugars_100g || 0, sodium: (nutriments.sodium_100g || 0) * 1000, potassium: (nutriments.potassium_100g || 0) * 1000,
                    };

                    let displayGrams = 100;
                    if (product.quantity) { const quantityMatch = String(product.quantity).match(/(\d+(\.\d+)?)/); if (quantityMatch) { displayGrams = parseFloat(quantityMatch[0]); }
                    } else if (product.serving_size) { const servingMatch = String(product.serving_size).match(/(\d+(\.\d+)?)/); if (servingMatch) { displayGrams = parseFloat(servingMatch[0]); } }
                    
                    const resultHtml = `
                        <div class="p-3 bg-input-bg rounded-lg">
                            <p class="font-bold">${product.product_name || 'Scanned Item'}</p>
                            <p class="text-xs text-gray-400">Barcode: ${decodedText}</p>
                            <button class="btn btn-primary !p-2 mt-2 w-full data-log-button">Log this</button>
                        </div>`;
                    ui.barcodeResults.innerHTML += resultHtml;
                    
                    const logButton = ui.barcodeResults.querySelector('.data-log-button:last-child');
                    logButton.onclick = () => {
                         const ratio = displayGrams / 100.0;
                         const foodItem = {
                            name: product.product_name || 'Scanned Item',
                            brand: product.brands || '',
                            servings: 1, // The whole product is one serving
                            grams: displayGrams,
                            calories: (aiBaseMacros.calories * ratio) || 0,
                            protein: (aiBaseMacros.protein * ratio) || 0,
                            carbs: (aiBaseMacros.carbs * ratio) || 0,
                            fat: (aiBaseMacros.fat * ratio) || 0,
                            sugar: (aiBaseMacros.sugar * ratio) || 0,
                            sodium: (aiBaseMacros.sodium * ratio) || 0,
                            potassium: (aiBaseMacros.potassium * ratio) || 0,
                         };
                         const dayLog = getDayLog(viewDate);
                         dayLog.entries.push(foodItem);
                         saveData();
                         updateDayView(viewDate);
                         logButton.textContent = 'Logged!';
                         logButton.disabled = true;
                         showCustomAlert('Success', `${foodItem.name} has been added to your log.`);
                    }

                } catch (error) {
                    ui.barcodeResults.innerHTML += `<div class="p-3 bg-input-bg rounded-lg text-yellow-400 text-center">Could not retrieve data for barcode. ${error.message}</div>`;
                } finally {
                    ui.barcodeScannerStatus.textContent = 'Ready for next scan...';
                }
            }
            function onScanFailure(error) { 
                // Don't display error messages for every frame that doesn't have a barcode.
            }
            
            ui.scanBarcodeBtn.addEventListener('click', () => { scanningIngredientRow = null; startBarcodeScanner(); });
            ui.closeBarcodeScannerModalBtn.addEventListener('click', stopBarcodeScanner);
            document.getElementById('start-camera-scan-btn')?.addEventListener('click', initiateLiveScanner);
            document.getElementById('barcode-upload-input')?.addEventListener('change', (e) => {
                const files = e.target.files; if (!files || files.length === 0) return;
                ui.barcodeResults.innerHTML = '';
                ui.barcodeScannerStatus.textContent = 'Scanning image(s)...';
                document.getElementById('barcode-initial-options').classList.add('hidden');
                
                Array.from(files).forEach(file => {
                     const qrCodeInstance = new Html5Qrcode("barcode-reader", { verbose: false });
                     qrCodeInstance.scanFile(file, false)
                        .then(decodedText => onScanSuccess(decodedText, {}))
                        .catch(err => ui.barcodeResults.innerHTML += `<div class="p-3 bg-input-bg rounded-lg text-yellow-400 text-center">No barcode found in image: ${file.name}.</div>` )
                        .finally(() => qrCodeInstance.clear());
                });
            });
            
            // --- AI Nutritionist Chat ---
            ui.openNutritionistChatBtn.addEventListener('click', () => {
                renderChatHistory();
                showModal(ui.aiNutritionistModal);
            });
            ui.closeAiNutritionistModalBtn.addEventListener('click', () => hideModal(ui.aiNutritionistModal));
            ui.aiChatSendBtn.addEventListener('click', handleAiChatSend);
            ui.aiChatInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') handleAiChatSend(); });

            async function handleAiChatSend() {
                const userInput = ui.aiChatInput.value.trim();
                if(!userInput) return;

                chatHistory.push({ role: "user", parts: [{ text: userInput }] });
                addMessageToChat(userInput, 'user');
                ui.aiChatInput.value = '';
                ui.aiChatSendBtn.disabled = true;
                addMessageToChat('<div class="loader"></div>', 'model', true);

                try {
                    const sevenDaysAgo = new Date();
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                    const recentLogs = Object.entries(allDailyLogs).filter(([date]) => new Date(date) >= sevenDaysAgo);
                    const context = `
                        User Profile: ${JSON.stringify(userProfile)}
                        Nutrition Goals: ${JSON.stringify(goals)}
                        Last 7 Days Food Log: ${JSON.stringify(recentLogs)}
                    `;
                    const systemPrompt = `You are FitTrack AI, a helpful and knowledgeable nutritionist. Analyze the user's provided data to give specific, actionable advice based on their question. Be encouraging and provide clear, concise answers. Here is the user's data context: ${context}`;
                    
                    const response = await fetch(getApiUrl('gemini-2.5-flash-preview-05-20'), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: chatHistory,
                            systemInstruction: { parts: [{ text: systemPrompt }] }
                        })
                    });
                    if(!response.ok) throw new Error('Failed to get response from AI.');
                    const result = await response.json();
                    const aiResponse = result.candidates[0].content.parts[0].text;
                    
                    chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                    updateLastMessage(aiResponse.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>'));

                } catch(error) {
                    updateLastMessage('Sorry, I am having trouble connecting right now. Please try again later.');
                    // Remove the last user message if AI fails, so they can try again
                    chatHistory.pop();
                } finally {
                    ui.aiChatSendBtn.disabled = false;
                    saveData();
                }
            }
            
            function renderChatHistory() {
                if(chatHistory.length === 0) {
                     ui.aiChatHistory.innerHTML = `<div class="text-center text-secondary-text p-4"><i data-lucide="bot" class="w-10 h-10 mx-auto mb-2"></i><p>Hello! I'm your AI Nutritionist. Ask me anything about your diet, food logs, or general nutrition.</p></div>`;
                     lucide.createIcons();
                } else {
                    ui.aiChatHistory.innerHTML = '';
                    chatHistory.forEach(msg => {
                        addMessageToChat(msg.parts[0].text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>'), msg.role);
                    });
                }
            }


            function addMessageToChat(message, sender, isLoading = false) {
                 if (chatHistory.length === 1 && sender === 'user') { ui.aiChatHistory.innerHTML = ''; }
                const messageDiv = document.createElement('div');
                messageDiv.className = `p-3 rounded-lg max-w-[85%] ${sender === 'user' ? 'bg-blue-600 self-end' : 'bg-input-bg self-start'}`;
                if(isLoading) messageDiv.id = 'ai-loading-message';
                messageDiv.innerHTML = message;
                ui.aiChatHistory.appendChild(messageDiv);
                ui.aiChatHistory.scrollTop = ui.aiChatHistory.scrollHeight;
            }
             function updateLastMessage(newMessage) {
                const loadingMessage = document.getElementById('ai-loading-message');
                if (loadingMessage) {
                    loadingMessage.innerHTML = newMessage;
                    loadingMessage.removeAttribute('id');
                }
             }
             
            // --- SWIPE GESTURES ---
            function handleItemDelete(element) {
                const type = element.dataset.type;
                const index = parseInt(element.dataset.index);
                const name = element.dataset.name;

                if (type === 'log') {
                    handleDeleteLogItem(index);
                } else if (type === 'food' || type === 'recipe') {
                    showConfirmModal(`Delete ${type}?`, `Are you sure you want to delete "${name}"?`, () => {
                        if (type === 'food') {
                            favoriteFoods.splice(index, 1);
                        } else if (type === 'recipe') {
                            savedRecipes.splice(index, 1);
                             const favIndex = favoriteFoods.findIndex(f => f.name.toLowerCase() === name.toLowerCase());
                            if (favIndex > -1) favoriteFoods.splice(favIndex, 1);
                        }
                        saveData();
                        fullRender();
                    });
                }
            }

            function handleItemEdit(element) {
                const type = element.dataset.type;
                const index = parseInt(element.dataset.index);
                
                if (type === 'log') {
                    handleEditLogItem(index);
                } else if (type === 'food') {
                    const food = favoriteFoods[index];
                    if (!food) return;
                    editingFavoriteFoodName = food.name;
                    document.getElementById('edit-fav-food-name').value = food.name;
                    document.getElementById('edit-fav-food-calories').value = food.calories.toFixed(2);
                    document.getElementById('edit-fav-food-protein').value = food.protein.toFixed(2);
                    document.getElementById('edit-fav-food-carbs').value = food.carbs.toFixed(2);
                    document.getElementById('edit-fav-food-fat').value = food.fat.toFixed(2);
                    showModal(ui.editFavoriteModal);
                } else if (type === 'recipe') {
                    const recipe = savedRecipes[index];
                    if (!recipe) return;
                    editingRecipeIndex = index;
                    ui.compoundFoodModal.querySelector('h2').textContent = "Edit Recipe";
                    ui.saveRecipeBtn.textContent = "Update Recipe";
                    ui.recipeNameInput.value = recipe.name;
                    ui.ingredientListContainer.innerHTML = '';
                    recipe.ingredients.forEach(ing => addIngredientRow(ing));
                    if (recipe.ingredients.length === 0) addIngredientRow();
                    updateRecipeTotals();
                    showModal(ui.compoundFoodModal);
                }
            }

            let pointerStart = { x: 0, y: 0 };
            let currentX = 0;
            let isSwiping = false;
            let swipedElement = null;
            let lastTap = 0;
            let pointerDelta = { x: 0, y: 0 }; 

            function getPointerCoordinates(e) {
                return e.touches ? { x: e.touches[0].clientX, y: e.touches[0].clientY } : { x: e.clientX, y: e.clientY };
            }

            function handlePointerDown(e) {
                const target = e.target.closest('.swipe-item');
                if (!target || e.target.closest('button, a, input, select, textarea')) return;

                const coords = getPointerCoordinates(e);
                pointerStart.x = coords.x;
                pointerStart.y = coords.y;
                pointerDelta = { x: 0, y: 0 };
                currentX = 0;
                swipedElement = target;
                swipedElement.querySelector('.swipe-content').classList.add('swiping');

                document.addEventListener('mousemove', handlePointerMove);
                document.addEventListener('mouseup', handlePointerUp);
                document.addEventListener('touchmove', handlePointerMove, { passive: false });
                document.addEventListener('touchend', handlePointerUp);
            }

            function handlePointerMove(e) {
                if (!swipedElement) return;

                const coords = getPointerCoordinates(e);
                const deltaX = coords.x - pointerStart.x;
                const deltaY = coords.y - pointerStart.y;
                pointerDelta = { x: deltaX, y: deltaY };

                if (!isSwiping && Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 10) {
                    isSwiping = true;
                }

                if (isSwiping) {
                    if (e.cancelable) e.preventDefault();
                    currentX = deltaX;
                    const content = swipedElement.querySelector('.swipe-content');
                    content.style.transform = `translateX(${currentX}px)`;

                    const rightAction = swipedElement.querySelector('.swipe-action-container.right');
                    const leftAction = swipedElement.querySelector('.swipe-action-container.left');

                    if (currentX < 0) { // Swiping left
                        if(rightAction) rightAction.style.opacity = Math.min(1, Math.abs(currentX) / 80).toString();
                        if(leftAction) leftAction.style.opacity = '0';
                    } else { // Swiping right
                        if(leftAction) leftAction.style.opacity = Math.min(1, currentX / 80).toString();
                        if(rightAction) rightAction.style.opacity = '0';
                    }
                }
            }

            function handlePointerUp(e) {
                document.removeEventListener('mousemove', handlePointerMove);
                document.removeEventListener('mouseup', handlePointerUp);
                document.removeEventListener('touchmove', handlePointerMove);
                document.removeEventListener('touchend', handlePointerUp);

                if (!swipedElement) return;

                const elementToClean = swipedElement;
                const content = elementToClean.querySelector('.swipe-content');
                
                const currentTime = new Date().getTime();
                const isDoubleTap = (currentTime - lastTap) < 300 && !isSwiping;
                lastTap = currentTime;

                const totalDistance = Math.sqrt(pointerDelta.x**2 + pointerDelta.y**2);

                if (isSwiping) {
                    const swipeThreshold = elementToClean.offsetWidth * 0.35;
                    content.classList.add('returning');
                    if (currentX < -swipeThreshold) { // Swiped left for Edit
                        handleItemEdit(elementToClean);
                        content.style.transform = 'translateX(0)';
                    } else if (currentX > swipeThreshold) { // Swiped right for Delete
                        handleItemDelete(elementToClean);
                    } else {
                        content.style.transform = 'translateX(0)';
                    }
                } else if (totalDistance < 10) { // It's a tap
                    if (isDoubleTap) {
                        const itemName = elementToClean.dataset.name;
                        if (itemName) {
                            toggleFavorite(itemName);
                        }
                    }
                }

                isSwiping = false;
                swipedElement = null;
                currentX = 0;
                pointerDelta = { x: 0, y: 0 };
                
                setTimeout(() => {
                    if(content) {
                        content.classList.remove('swiping', 'returning');
                        content.style.transform = '';
                    }
                    elementToClean.querySelectorAll('.swipe-action-container').forEach(el => el.style.opacity = '0');
                }, 300);
            }
            
            ui.dailyLogContentDiv.addEventListener('mousedown', handlePointerDown);
            ui.dailyLogContentDiv.addEventListener('touchstart', handlePointerDown, { passive: true });
            ui.savedItemsListDiv.addEventListener('mousedown', handlePointerDown);
            ui.savedItemsListDiv.addEventListener('touchstart', handlePointerDown, { passive: true });

            // --- DAY VIEW SWIPE GESTURES ---
            let daySwipeStart = { x: 0, y: 0 };
            let daySwipeCurrentX = 0;
            let isDaySwiping = false;
            let daySwipeElement = null;

            function handleDaySwipePointerDown(e) {
                const target = e.target.closest('#daily-summary-card');
                if (!target) return;

                const coords = getPointerCoordinates(e); 
                daySwipeStart.x = coords.x;
                daySwipeStart.y = coords.y;
                daySwipeCurrentX = 0;
                daySwipeElement = target;

                document.addEventListener('mousemove', handleDaySwipePointerMove);
                document.addEventListener('mouseup', handleDaySwipePointerUp);
                document.addEventListener('touchmove', handleDaySwipePointerMove, { passive: false });
                document.addEventListener('touchend', handleDaySwipePointerUp);
            }

            function handleDaySwipePointerMove(e) {
                if (!daySwipeElement) return;

                const coords = getPointerCoordinates(e);
                const deltaX = coords.x - daySwipeStart.x;
                const deltaY = coords.y - daySwipeStart.y;

                if (!isDaySwiping && Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 10) {
                    isDaySwiping = true;
                }

                if (isDaySwiping) {
                    if (e.cancelable) e.preventDefault();
                    daySwipeCurrentX = deltaX;
                    daySwipeElement.style.transition = 'none';
                    daySwipeElement.style.transform = `translateX(${daySwipeCurrentX}px)`;
                }
            }

            function handleDaySwipePointerUp(e) {
                document.removeEventListener('mousemove', handleDaySwipePointerMove);
                document.removeEventListener('mouseup', handleDaySwipePointerUp);
                document.removeEventListener('touchmove', handleDaySwipePointerMove);
                document.removeEventListener('touchend', handleDaySwipePointerUp);

                if (!daySwipeElement) return;

                if (isDaySwiping) {
                    const swipeThreshold = daySwipeElement.offsetWidth * 0.25;
                    
                    daySwipeElement.style.transition = 'transform 0.3s ease';
                    daySwipeElement.style.transform = 'translateX(0)';

                    if (daySwipeCurrentX < -swipeThreshold) { // Swiped left for Next Day
                        const today = new Date(); today.setHours(0, 0, 0, 0);
                        const nextDay = new Date(viewDate); nextDay.setDate(nextDay.getDate() + 1);
                        if (nextDay.getTime() <= today.getTime()) {
                            viewDate.setDate(viewDate.getDate() + 1);
                            updateDayView(viewDate);
                        }
                    } else if (daySwipeCurrentX > swipeThreshold) { // Swiped right for Previous Day
                        viewDate.setDate(viewDate.getDate() - 1);
                        updateDayView(viewDate);
                    }
                }

                isDaySwiping = false;
                
                setTimeout(() => {
                    if(daySwipeElement) {
                       daySwipeElement.style.transition = '';
                       daySwipeElement.style.transform = '';
                    }
                    daySwipeElement = null;
                }, 300);
            }
            
            ui.dailySummaryCard.addEventListener('mousedown', handleDaySwipePointerDown);
            ui.dailySummaryCard.addEventListener('touchstart', handleDaySwipePointerDown, { passive: true });

            // --- INITIALIZATION ---
            loadData();
            updateDayView(viewDate);
        });
    </script>
</body>
</html>
