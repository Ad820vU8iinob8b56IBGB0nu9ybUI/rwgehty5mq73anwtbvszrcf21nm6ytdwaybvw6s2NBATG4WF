<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitTrack AI | Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Dark theme is the default */
        :root {
            --background: #000000;
            --primary-text: #eaeaea;
            --secondary-text: #888888;
            --card-bg: #111111;
            --input-bg: #191919;
            --border-color: #222222;
            --accent: #FFFFFF;
            --accent-hover: #DDDDDD;
            --danger: #E53E3E;
            --sidebar-bg: #09090b;
        }

        /* Light theme overrides */
        [data-theme="light"] {
            --background: #f8fafc; /* slate-50 */
            --primary-text: #0f172a; /* slate-900 */
            --secondary-text: #64748b; /* slate-500 */
            --card-bg: #ffffff;
            --input-bg: #f1f5f9; /* slate-100 */
            --border-color: #e2e8f0; /* slate-200 */
            --accent: #0f172a; /* slate-900 */
            --accent-hover: #334155; /* slate-700 */
            --sidebar-bg: #ffffff;
        }

        body {
            background-color: var(--background);
            color: var(--primary-text);
            font-family: 'Manrope', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        body.menu-open {
            overflow: hidden;
        }

        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .nav-link {
            transition: color 0.3s ease, border-color 0.3s ease;
            border-bottom: 2px solid transparent;
            color: var(--secondary-text);
            padding-bottom: 4px;
        }

        .nav-link:hover { color: var(--primary-text); }
        .nav-link.active { color: var(--primary-text); border-bottom-color: var(--primary-text); }
        
        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            color: var(--secondary-text);
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .sidebar-link:hover {
            background-color: var(--input-bg);
            color: var(--primary-text);
        }
        .sidebar-link.active {
            background-color: var(--input-bg);
            color: var(--primary-text);
            font-weight: 600;
        }

        .mobile-sidebar-link {
            color: var(--secondary-text);
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        .mobile-sidebar-link.active {
            color: var(--primary-text);
            border-bottom-color: var(--accent);
        }

        .content-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 2rem;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .form-input, .form-select {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            color: var(--primary-text);
            padding: 0.75rem 1rem;
            width: 100%;
            transition: all 0.3s ease;
        }
        
        [data-theme="light"] .form-select {
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23334155' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        }
        [data-theme="dark"] .form-select {
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent) 20%, transparent);
        }

        .form-label { color: var(--secondary-text); font-size: 0.875rem; font-weight: 500; }
        .btn { border-radius: 0.5rem; font-weight: 600; padding: 0.75rem 1.5rem; transition: all 0.2s ease-in-out; text-align: center; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; transform: translateY(0); }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: translateY(0); }
        .btn-primary { background-color: var(--accent); color: var(--background); }
        .btn-primary:hover:not(:disabled) { background-color: var(--accent-hover); }
        .btn-secondary { background-color: transparent; border: 1px solid var(--border-color); color: var(--primary-text); }
        .btn-secondary:hover:not(:disabled) { background-color: var(--border-color); }
        .btn-danger { background-color: var(--danger); color: var(--primary-text); }
        .btn-danger:hover:not(:disabled) { background-color: #C53030; }

        .modal-backdrop { display: none; position: fixed; z-index: 50; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center; animation: fadeIn 0.3s ease; }
        .modal-content { background-color: var(--card-bg); border: 1px solid var(--border-color); padding: 2rem; border-radius: 0.75rem; width: 90%; max-width: 550px; max-height: 90vh; overflow-y: auto; animation: slideIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .loader { border: 2px solid #333; border-top: 2px solid var(--accent); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .theme-btn.active { background-color: var(--accent); color: var(--background); }
        .content-panel { display: none; }
        .content-panel.active { display: block; animation: fadeIn 0.5s ease; }
    </style>
</head>
<body class="antialiased">
    
    <script>
        (function() {
            const theme = localStorage.getItem('fitTrackAI_theme') || 'dark';
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>

    <div class="container mx-auto max-w-7xl px-4 py-8">
        <!-- Header -->
        <header class="flex flex-col sm:flex-row items-center justify-between mb-8 pb-4 border-b border-border-color">
            <a href="index.html" class="flex items-center gap-3">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m6 2 4 4"/><path d="m3 10.5 4.5-4.5"/><path d="m13.5 21 4.5-4.5"/></svg>
                <h1 class="text-2xl font-bold">FitTrack AI</h1>
            </a>
            <nav class="hidden sm:flex mt-4 sm:mt-0">
                <ul class="flex items-center space-x-6 text-base font-medium">
                    <li><a href="index.html" class="nav-link">Home</a></li>
                    <li><a href="nutrition.html" class="nav-link">Nutrition</a></li>
                    <li><a href="workouts.html" class="nav-link">Workouts</a></li>
                    <li><a href="sleep.html" class="nav-link">Sleep</a></li>
                    <li><a href="profile.html" class="nav-link active">Profile</a></li>
                </ul>
            </nav>
        </header>

        <!-- Mobile Sub-navigation -->
        <nav id="mobile-settings-nav" class="md:hidden flex items-center justify-center border-b border-border-color mb-6">
            <a href="#" class="mobile-sidebar-link flex-1 text-center p-3 font-semibold" data-target="profile-content">Profile</a>
            <a href="#" class="mobile-sidebar-link flex-1 text-center p-3 font-semibold" data-target="goals-content">Goals</a>
            <a href="#" class="mobile-sidebar-link flex-1 text-center p-3 font-semibold" data-target="account-content">Account</a>
        </nav>


        <div class="flex flex-col md:flex-row gap-8 lg:gap-12">
            <!-- Sidebar -->
            <aside class="hidden md:block md:w-64 flex-shrink-0">
                <nav id="settings-sidebar" class="space-y-1">
                    <a href="#" class="sidebar-link active" data-target="profile-content"><i data-lucide="user-circle"></i>Profile</a>
                    <a href="#" class="sidebar-link" data-target="goals-content"><i data-lucide="target"></i>Goals</a>
                    <a href="#" class="sidebar-link" data-target="account-content"><i data-lucide="lock"></i>Account</a>
                </nav>
            </aside>

            <!-- Main Content Area -->
            <main class="flex-1 min-w-0">
                <!-- Profile Panel -->
                <div id="profile-content" class="content-panel active">
                    <div class="space-y-8">
                        <div class="content-card">
                            <h2 class="text-2xl font-semibold mb-6">Personal Info</h2>
                             <div class="flex flex-col sm:flex-row items-center gap-8">
                                <div class="flex-shrink-0 text-center">
                                    <img src="https://placehold.co/128x128/191919/FFFFFF?text=User" alt="User" class="w-32 h-32 rounded-full mx-auto border-2 border-border-color">
                                    <button class="text-sm text-blue-400 hover:underline mt-2">Change Picture</button>
                                </div>
                                <div class="w-full space-y-4">
                                    <div>
                                        <label for="user-name" class="form-label">Name</label>
                                        <input type="text" id="user-name" class="form-input mt-1" placeholder="Your Name">
                                    </div>
                                    <div>
                                        <label for="user-bio" class="form-label">Bio</label>
                                        <textarea id="user-bio" rows="2" class="form-input mt-1" placeholder="A little about yourself..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="content-card">
                            <h2 class="text-2xl font-semibold mb-4">Appearance</h2>
                            <p class="text-sm text-secondary-text mb-4">Choose your preferred theme.</p>
                             <div class="flex gap-2 p-1 rounded-lg bg-input-bg">
                                <button id="theme-light-btn" class="theme-btn w-full btn btn-secondary"><i data-lucide="sun"></i>Light</button>
                                <button id="theme-dark-btn" class="theme-btn w-full btn btn-secondary"><i data-lucide="moon"></i>Dark</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Goals Panel -->
                <div id="goals-content" class="content-panel">
                    <div class="space-y-8">
                        <div class="content-card">
                            <h2 class="text-2xl font-semibold mb-6">Health & Fitness Stats</h2>
                            <form id="profile-form" class="space-y-4">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="age" class="form-label">Age</label><input type="number" id="age" class="form-input mt-1" required></div><div><label for="gender" class="form-label">Gender</label><select id="gender" class="form-input mt-1"><option value="male">Male</option><option value="female">Female</option></select></div></div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="height" class="form-label">Height (cm)</label><input type="number" id="height" class="form-input mt-1" required></div><div><label for="weight" class="form-label">Weight (kg)</label><input type="number" id="weight" step="0.1" class="form-input mt-1" required></div></div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="smm" class="form-label">SMM (kg) (Optional)</label><input type="number" step="0.1" id="smm" class="form-input mt-1"></div><div><label for="bfm" class="form-label">Body Fat Mass (kg) (Optional)</label><input type="number" id="bfm" step="0.1" class="form-input mt-1"></div></div>
                                <div><label for="activity-level" class="form-label">Activity Level</label><select id="activity-level" class="form-input mt-1"><option value="1.2">Sedentary</option><option value="1.375">Lightly active</option><option value="1.55" selected>Moderately active</option><option value="1.725">Very active</option><option value="1.9">Extra active</option></select></div>
                                <div><label for="user-goal" class="form-label">Primary Goal</label><select id="user-goal" class="form-input mt-1"><option value="lose">Fat Loss</option><option value="maintain">Maintain Weight</option><option value="gain">Muscle Gain</option><option value="recomposition" selected>Recomposition</option></select></div>
                                <div id="recomp-deficit-container" class="hidden"><label for="recomp-deficit-input" class="form-label">Calorie Deficit (kcal)</label><input type="number" id="recomp-deficit-input" value="500" class="form-input mt-1"></div>
                                <button type="submit" class="w-full btn btn-primary !mt-6"><span class="btn-text">Save & Calculate Goals</span><div class="loader hidden"></div></button>
                                <div class="pt-4 mt-4 border-t border-border-color space-y-2 text-center"><div class="flex items-center justify-center gap-2"><label for="bmr-input" class="font-semibold text-gray-300">BMR (Override):</label><input type="number" id="bmr-input" class="form-input !w-24 !p-1 text-center" placeholder="Auto"><span class="text-gray-400">kcal</span></div><div class="flex items-center justify-center gap-2"><label for="bmi-input" class="font-semibold text-gray-300">BMI:</label><input type="number" step="0.1" id="bmi-input" class="form-input !w-24 !p-1 text-center bg-transparent border-0" readonly></div></div>
                            </form>
                        </div>
                        <div class="content-card">
                            <h2 class="text-2xl font-semibold mb-4">Daily Check-in</h2>
                            <p class="text-sm text-secondary-text mb-4">Log your weight daily to help the AI adapt your calorie goals for better results.</p>
                            <form id="check-in-form" class="flex flex-col sm:flex-row gap-4"><input type="number" step="0.1" id="check-in-weight" placeholder="Current weight (kg)" class="form-input w-full" required><button type="submit" id="check-in-btn" class="btn btn-secondary sm:w-auto flex-shrink-0"><span class="btn-text">Check In</span><div class="loader hidden"></div></button></form>
                            <div id="check-in-feedback" class="mt-4 text-sm h-5 text-center"></div>
                        </div>
                        <div class="content-card">
                            <h2 class="text-2xl font-semibold mb-4">AI Adaptive Calorie & Macro Plan</h2>
                            <div id="calorie-plan-output"><p>Please fill out your profile to generate a plan.</p></div>
                        </div>
                        <div class="content-card">
                            <h2 class="text-2xl font-semibold mb-4">Body Composition Progress</h2>
                            <div class="w-full h-96 flex items-center justify-center"><canvas id="progress-chart"></canvas></div>
                        </div>
                    </div>
                </div>
                
                <!-- Account Panel -->
                <div id="account-content" class="content-panel">
                    <div class="space-y-8">
                        <div class="content-card">
                            <h2 class="text-2xl font-semibold mb-4">Account Settings</h2>
                            <p class="text-secondary-text">Account management features are coming soon.</p>
                        </div>
                         <div class="content-card">
                            <h2 class="text-2xl font-semibold mb-4">Data Management</h2>
                            <p class="text-sm text-secondary-text mb-6">Save your data to a file or restore from a backup. Deleting is permanent.</p>
                            <div class="space-y-4">
                                <button id="backup-data-btn" class="w-full btn btn-secondary"><i data-lucide="download"></i>Backup All Data</button>
                                <label for="restore-data-input" class="w-full btn btn-secondary cursor-pointer"><i data-lucide="upload"></i>Restore From Backup</label>
                                <input type="file" id="restore-data-input" class="hidden" accept=".json">
                                <button id="delete-all-data-btn" class="w-full btn btn-danger"><i data-lucide="trash-2"></i>Delete All Data</button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="confirm-modal" class="modal-backdrop"><div class="modal-content"><h2 id="confirm-modal-title" class="text-xl font-bold mb-4">Are you sure?</h2><p id="confirm-modal-text" class="text-secondary-text mb-6">This action cannot be undone.</p><div class="flex justify-end gap-4"><button id="confirm-modal-cancel-btn" class="btn btn-secondary">Cancel</button><button id="confirm-modal-confirm-btn" class="btn btn-danger">Confirm</button></div></div></div>
    <div id="alert-modal" class="modal-backdrop"><div class="modal-content"><h2 id="alert-modal-title" class="text-xl font-bold mb-4">Alert</h2><p id="alert-modal-text" class="text-secondary-text mb-6"></p><div class="flex justify-end"><button id="alert-modal-ok-btn" class="btn btn-primary">OK</button></div></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let userProfile = { weightHistory: [], inbodyHistory: [] };
            let goals = { calories: 2000, protein: 150, carbs: 225, fat: 60 };
            let confirmCallback = null;

            // --- UI ELEMENT DEFINITIONS ---
            const ui = {
                profileForm: document.getElementById('profile-form'),
                caloriePlanOutput: document.getElementById('calorie-plan-output'),
                checkInForm: document.getElementById('check-in-form'),
                checkInBtn: document.getElementById('check-in-btn'),
                checkInFeedback: document.getElementById('check-in-feedback'),
                bmrInput: document.getElementById('bmr-input'),
                bmiInput: document.getElementById('bmi-input'),
                userGoalSelect: document.getElementById('user-goal'),
                recompDeficitContainer: document.getElementById('recomp-deficit-container'),
                // Modals
                confirmModal: document.getElementById('confirm-modal'),
                alertModal: document.getElementById('alert-modal'),
                // Data management
                backupDataBtn: document.getElementById('backup-data-btn'),
                restoreDataInput: document.getElementById('restore-data-input'),
                deleteAllDataBtn: document.getElementById('delete-all-data-btn'),
                // Theme
                themeLightBtn: document.getElementById('theme-light-btn'),
                themeDarkBtn: document.getElementById('theme-dark-btn'),
                // Sidebar Navigation
                sidebar: document.getElementById('settings-sidebar'),
                mobileNav: document.getElementById('mobile-settings-nav'),
                contentPanels: document.querySelectorAll('.content-panel'),
            };
            
            // --- CHART.JS SETUP ---
            let chartTextColor, chartGridColor;
            const progressCtx = document.getElementById('progress-chart').getContext('2d');
            let progressChart = new Chart(progressCtx, {
                type: 'line', data: { labels: [], datasets: [] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: {}, x: {} },
                    plugins: { legend: { display: true, labels: {} } }
                }
            });

            // --- CORE & HELPER FUNCTIONS ---
            function showModal(modalElement) { modalElement.style.display = 'flex'; }
            function hideModal(modalElement) { modalElement.style.display = 'none'; }
            function showCustomAlert(title, text) { document.getElementById('alert-modal-title').textContent = title; document.getElementById('alert-modal-text').textContent = text; showModal(ui.alertModal); }
            function showConfirmModal(title, text, onConfirm) { document.getElementById('confirm-modal-title').textContent = title; document.getElementById('confirm-modal-text').textContent = text; confirmCallback = onConfirm; showModal(ui.confirmModal); }

            function saveData() {
                localStorage.setItem('fitTrackAI_userProfile', JSON.stringify(userProfile));
                localStorage.setItem('fitTrackAI_goals', JSON.stringify(goals));
            }

            function loadData() {
                userProfile = JSON.parse(localStorage.getItem('fitTrackAI_userProfile')) || { weightHistory: [], inbodyHistory: [] };
                goals = JSON.parse(localStorage.getItem('fitTrackAI_goals')) || { calories: 2000, protein: 150, carbs: 225, fat: 60 };
                if (!userProfile.weightHistory) userProfile.weightHistory = [];
                if (!userProfile.inbodyHistory) userProfile.inbodyHistory = [];
            }
            
            function renderProgressChart() {
                const weightData = userProfile.weightHistory || [];
                const inbodyData = userProfile.inbodyHistory || [];

                if (weightData.length === 0 && inbodyData.length === 0) {
                    progressChart.data = { labels: [], datasets: [] };
                    progressChart.update();
                    return;
                }

                const allDates = new Set([...weightData.map(d => d.date), ...inbodyData.map(d => d.date)]);
                const sortedLabels = Array.from(allDates).sort((a, b) => new Date(a) - new Date(b));

                const weightMap = new Map(weightData.map(d => [d.date, d.weight]));
                const smmMap = new Map(inbodyData.map(d => [d.date, d.smm]));
                const bfmMap = new Map(inbodyData.map(d => [d.date, d.bfm]));

                progressChart.data.labels = sortedLabels.map(date => new Date(date.replace(/-/g, '/')).toLocaleDateString(undefined, { month: 'short', day: 'numeric' }));
                progressChart.data.datasets = [
                    { label: 'Weight (kg)', data: sortedLabels.map(date => weightMap.get(date) || null), borderColor: '#60a5fa', backgroundColor: 'rgba(96, 165, 250, 0.2)', tension: 0.2, fill: true, spanGaps: true, },
                    { label: 'SMM (kg)', data: sortedLabels.map(date => smmMap.get(date) || null), borderColor: '#34d399', backgroundColor: 'rgba(52, 211, 153, 0.2)', tension: 0.2, fill: true, spanGaps: true, },
                    { label: 'BFM (kg)', data: sortedLabels.map(date => bfmMap.get(date) || null), borderColor: '#fbbf24', backgroundColor: 'rgba(251, 191, 36, 0.2)', tension: 0.2, fill: true, spanGaps: true, }
                ];
                progressChart.update();
            }

            function populateProfileForm() {
                if (userProfile.age) {
                    ui.profileForm.age.value = userProfile.age;
                    ui.profileForm.gender.value = userProfile.gender;
                    ui.profileForm.height.value = userProfile.height;
                    ui.profileForm.weight.value = userProfile.weight;
                    ui.profileForm.smm.value = userProfile.smm || '';
                    ui.profileForm.bfm.value = userProfile.bfm || '';
                    ui.profileForm['activity-level'].value = userProfile.activityLevel;
                    ui.profileForm['user-goal'].value = userProfile.goal;
                    if(userProfile.bmr) ui.bmrInput.value = Math.round(userProfile.bmr); else ui.bmrInput.placeholder = 'Auto';
                    if(userProfile.bmi) ui.bmiInput.value = userProfile.bmi.toFixed(1);
                    ui.recompDeficitContainer.value = userProfile.recompDeficit || 500;
                }
                updateGoalSpecificUI();
            }

            function generateCaloriePlan() {
                 if(!goals.calories || goals.calories === 0) { ui.caloriePlanOutput.innerHTML = '<p>Please fill out your profile to generate a plan.</p>'; return; }
                const { tdee } = userProfile;
                let planHtml = `<p class="mb-4">Your estimated maintenance calories are <strong class="text-xl text-blue-400">${Math.round(tdee)} kcal</strong>. Based on your goal, here is your adaptive plan:</p>`;
                planHtml += `<div class="grid grid-cols-2 gap-4 text-center"><div><p class="text-sm text-secondary-text">Daily Calories</p><p class="font-bold text-2xl">${Math.round(goals.calories)}</p></div><div><p class="text-sm text-secondary-text">Daily Protein</p><p class="font-bold text-2xl">${Math.round(goals.protein)}g</p></div><div><p class="text-sm text-secondary-text">Daily Carbs</p><p class="font-bold text-2xl">${Math.round(goals.carbs)}g</p></div><div><p class="text-sm text-secondary-text">Daily Fat</p><p class="font-bold text-2xl">${Math.round(goals.fat)}g</p></div></div>`;
                planHtml += `<p class="text-xs text-secondary-text mt-4 text-center">This plan will adapt based on your daily check-ins to ensure consistent progress.</p>`;
                ui.caloriePlanOutput.innerHTML = planHtml;
            }

            function calculateAndSaveGoals(showFeedback = true) {
                const btn = ui.profileForm.querySelector('button[type="submit"]');
                userProfile.age = parseInt(ui.profileForm.age.value); userProfile.gender = ui.profileForm.gender.value; userProfile.height = parseInt(ui.profileForm.height.value); userProfile.weight = parseFloat(ui.profileForm.weight.value); userProfile.smm = parseFloat(ui.profileForm.smm.value) || null; userProfile.bfm = parseFloat(ui.profileForm.bfm.value) || null; userProfile.activityLevel = parseFloat(ui.profileForm['activity-level'].value); userProfile.goal = ui.profileForm['user-goal'].value; userProfile.recompDeficit = parseInt(document.getElementById('recomp-deficit-input').value) || 500;
                
                const today = new Date().toISOString().split('T')[0];
                const lastWeightEntryIndex = userProfile.weightHistory.findIndex(entry => entry.date === today);
                if(lastWeightEntryIndex > -1) { userProfile.weightHistory[lastWeightEntryIndex].weight = userProfile.weight; }
                else { userProfile.weightHistory.push({ date: today, weight: userProfile.weight }); }
                if (userProfile.smm && userProfile.bfm) { const todayInBodyIndex = userProfile.inbodyHistory.findIndex(entry => entry.date === today); if (todayInBodyIndex > -1) { userProfile.inbodyHistory[todayInBodyIndex] = { ...userProfile.inbodyHistory[todayInBodyIndex], smm: userProfile.smm, bfm: userProfile.bfm }; } else { userProfile.inbodyHistory.push({ date: today, smm: userProfile.smm, bfm: userProfile.bfm }); } }

                let bmr; const manualBMR = parseFloat(ui.bmrInput.value);
                if (manualBMR > 0) { bmr = manualBMR; } 
                else { if (userProfile.gender === 'male') bmr = 10 * userProfile.weight + 6.25 * userProfile.height - 5 * userProfile.age + 5; else bmr = 10 * userProfile.weight + 6.25 * userProfile.height - 5 * userProfile.age - 161; ui.bmrInput.placeholder = Math.round(bmr); ui.bmrInput.value = ''; }
                userProfile.bmr = bmr;
                const bmi = userProfile.weight / ((userProfile.height / 100) ** 2); userProfile.bmi = bmi; ui.bmiInput.value = bmi.toFixed(1);
                const tdee = bmr * userProfile.activityLevel; userProfile.tdee = tdee;

                let calorieTarget = tdee;
                if(userProfile.goal === 'lose') calorieTarget -= 300; if(userProfile.goal === 'gain') calorieTarget += 300; if(userProfile.goal === 'recomposition') calorieTarget = tdee - userProfile.recompDeficit;
                goals.calories = Math.round(calorieTarget); goals.protein = Math.round(userProfile.weight * 2.2); goals.fat = Math.round(userProfile.weight * 0.8); goals.carbs = Math.round((goals.calories - (goals.protein * 4 + goals.fat * 9)) / 4);

                generateCaloriePlan(); saveData(); renderProgressChart();
                if (showFeedback) { btn.querySelector('.btn-text').textContent = "Saved!"; setTimeout(() => { btn.querySelector('.btn-text').textContent = "Save & Calculate Goals"; }, 2000); }
            }
            
            function updateGoalSpecificUI() { document.getElementById('recomp-deficit-container').classList.toggle('hidden', ui.userGoalSelect.value !== 'recomposition'); }

            function applyTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('fitTrackAI_theme', theme);
                ui.themeLightBtn.classList.toggle('active', theme === 'light');
                ui.themeDarkBtn.classList.toggle('active', theme === 'dark');
                
                chartTextColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-text').trim();
                chartGridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();

                Chart.defaults.color = chartTextColor;
                progressChart.options.scales.y = { ticks: { color: chartTextColor }, grid: { color: chartGridColor } };
                progressChart.options.scales.x = { ticks: { color: chartTextColor }, grid: { color: chartGridColor } };
                progressChart.options.plugins.legend.labels.color = chartTextColor;
                progressChart.update();
            }

            function navigate(targetId) {
                ui.contentPanels.forEach(panel => panel.classList.remove('active'));
                document.getElementById(targetId)?.classList.add('active');
                
                ui.sidebar.querySelectorAll('.sidebar-link').forEach(link => link.classList.remove('active'));
                ui.sidebar.querySelector(`[data-target="${targetId}"]`)?.classList.add('active');
                
                ui.mobileNav.querySelectorAll('.mobile-sidebar-link').forEach(link => link.classList.remove('active'));
                ui.mobileNav.querySelector(`[data-target="${targetId}"]`)?.classList.add('active');

                localStorage.setItem('fitTrackAI_activeProfileTab', targetId);
                
                if (targetId === 'goals-content') { renderProgressChart(); }
            }

            function fullRender() {
                populateProfileForm();
                if(userProfile.age) generateCaloriePlan();
                renderProgressChart();
                lucide.createIcons();
            }
            
            function setupNavigation() {
                [ui.sidebar, ui.mobileNav].forEach(bar => {
                    bar.addEventListener('click', e => {
                        e.preventDefault();
                        const link = e.target.closest('a');
                        if (link && link.dataset.target) {
                            navigate(link.dataset.target);
                        }
                    });
                });
            }

            // --- EVENT LISTENERS ---
            ui.profileForm.addEventListener('submit', (e) => { 
                e.preventDefault(); 
                if(!ui.profileForm.age.value || !ui.profileForm.height.value || !ui.profileForm.weight.value){ showCustomAlert('Missing Information', 'Please fill in Age, Height, and Weight to calculate your goals.'); return; }
                calculateAndSaveGoals(); 
            });

            ui.checkInForm.addEventListener('submit', async (e) => {
                e.preventDefault(); const btn = ui.checkInBtn; const weightInput = document.getElementById('check-in-weight'); const newWeight = parseFloat(weightInput.value);
                if (!newWeight || newWeight <= 0) { ui.checkInFeedback.textContent = "Please enter a valid weight."; ui.checkInFeedback.classList.add('text-red-400'); return; }
                if (!userProfile.age) { ui.checkInFeedback.textContent = "Please fill out your profile first."; ui.checkInFeedback.classList.add('text-red-400'); return; }
                btn.disabled = true; btn.querySelector('.btn-text').style.display = 'none'; btn.querySelector('.loader').classList.remove('hidden');
                const today = new Date().toISOString().split('T')[0]; const todayEntryIndex = userProfile.weightHistory.findIndex(entry => entry.date === today);
                if (todayEntryIndex > -1) { userProfile.weightHistory[todayEntryIndex].weight = newWeight; } else { userProfile.weightHistory.push({ date: today, weight: newWeight }); }
                userProfile.weight = newWeight; ui.profileForm.weight.value = newWeight; 
                calculateAndSaveGoals(false); await new Promise(resolve => setTimeout(resolve, 500)); 
                ui.checkInFeedback.textContent = `Weight for ${today} logged as ${newWeight} kg. Goals updated.`; ui.checkInFeedback.classList.remove('text-red-400'); ui.checkInFeedback.classList.add('text-green-400');
                weightInput.value = ''; btn.disabled = false; btn.querySelector('.btn-text').style.display = 'inline'; btn.querySelector('.loader').classList.add('hidden');
            });
            
            ui.userGoalSelect.addEventListener('change', updateGoalSpecificUI);
            document.getElementById('alert-modal-ok-btn').addEventListener('click', () => hideModal(ui.alertModal));
            document.getElementById('confirm-modal-cancel-btn').addEventListener('click', () => hideModal(ui.confirmModal));
            document.getElementById('confirm-modal-confirm-btn').addEventListener('click', () => { if (confirmCallback) confirmCallback(); hideModal(ui.confirmModal); });

            ui.backupDataBtn.addEventListener('click', () => {
                const allData = {}; Object.keys(localStorage).filter(key => key.startsWith('fitTrackAI_')).forEach(key => { allData[key.replace('fitTrackAI_', '')] = JSON.parse(localStorage.getItem(key)); });
                const blob = new Blob([JSON.stringify(allData, null, 2)], {type: "application/json"}); const a = document.createElement('a');
                a.href = URL.createObjectURL(blob); a.download = `fittrack_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click(); URL.revokeObjectURL(a.href); showCustomAlert('Success', 'Your data has been backed up.');
            });
            ui.restoreDataInput.addEventListener('change', (e) => {
                const file = e.target.files[0]; if(!file) return; const reader = new FileReader();
                reader.onload = (event) => {
                    try { const restoredData = JSON.parse(event.target.result); Object.keys(localStorage).filter(key => key.startsWith('fitTrackAI_')).forEach(key => localStorage.removeItem(key)); Object.keys(restoredData).forEach(key => { localStorage.setItem(`fitTrackAI_${key}`, JSON.stringify(restoredData[key])); }); showCustomAlert('Success', 'Data restored. The page will reload.'); setTimeout(() => location.reload(), 2000);
                    } catch (err) { showCustomAlert('Error', 'Could not read the backup file.'); }
                };
                reader.readAsText(file); e.target.value = '';
            });
            ui.deleteAllDataBtn.addEventListener('click', () => { showConfirmModal('Delete All Data?', 'This will permanently erase all application data.', () => { Object.keys(localStorage).filter(key => key.startsWith('fitTrackAI_')).forEach(key => localStorage.removeItem(key)); showCustomAlert('Data Deleted', 'All data has been cleared. The page will reload.'); setTimeout(() => location.reload(), 2000); }); });

            ui.themeLightBtn.addEventListener('click', () => applyTheme('light'));
            ui.themeDarkBtn.addEventListener('click', () => applyTheme('dark'));

            // --- INITIALIZATION ---
            loadData();
            applyTheme(localStorage.getItem('fitTrackAI_theme') || 'dark');
            setupNavigation();
            fullRender();
            const lastTab = localStorage.getItem('fitTrackAI_activeProfileTab') || 'profile-content';
            navigate(lastTab);
        });
    </script>
</body>
</html>

